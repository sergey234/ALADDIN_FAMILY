package family.aladdin.android.ui.components.modals

import androidx.camera.core.*
import androidx.camera.lifecycle.ProcessCameraProvider
import androidx.camera.view.PreviewView
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalLifecycleOwner
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.viewinterop.AndroidView
import androidx.compose.ui.window.Dialog
import androidx.compose.ui.window.DialogProperties
import androidx.core.content.ContextCompat
import com.google.mlkit.vision.barcode.BarcodeScannerOptions
import com.google.mlkit.vision.barcode.BarcodeScanning
import com.google.mlkit.vision.barcode.common.Barcode
import com.google.mlkit.vision.common.InputImage
import family.aladdin.android.ui.components.buttons.SecondaryButton
import family.aladdin.android.ui.theme.*
import java.util.concurrent.ExecutorService
import java.util.concurrent.Executors

/**
 * üì∑ QR Scanner Modal
 * –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–æ–≤
 * 
 * –†–ê–ó–ú–ï–†–´ (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ):
 * - Modal width: 340dp
 * - Modal height: 520dp
 * - Camera preview: 280dp √ó 280dp
 * - Scan frame: 180dp √ó 180dp (—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
 * 
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
 * - –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —Å–µ–º—å–µ (QR #1)
 * - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏ (QR #1)
 * - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π QR #2
 */

@Composable
fun QRScannerModal(
    mode: QRScanMode,
    onCodeScanned: (String) -> Unit,
    onDismiss: () -> Unit
) {
    var showManualInput by remember { mutableStateOf(false) }
    
    Dialog(
        onDismissRequest = onDismiss,
        properties = DialogProperties(
            dismissOnBackPress = true,
            dismissOnClickOutside = false
        )
    ) {
        Card(
            modifier = Modifier
                .width(340.dp)
                .wrapContentHeight(),
            shape = RoundedCornerShape(24.dp),
            colors = CardDefaults.cardColors(
                containerColor = Color.Transparent
            )
        ) {
            Box(
                modifier = Modifier
                    .background(
                        Brush.linearGradient(
                            colors = listOf(
                                Color(0xFF0F172A),  // –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ç—ë–º–Ω—ã–π
                                Color(0xFF1E3A8A),  // –ì–ª—É–±–æ–∫–∏–π —Å–∏–Ω–∏–π
                                Color(0xFF3B82F6),  // –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π —Å–∏–Ω–∏–π
                                Color(0xFF1E40AF)   // –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π —Å–∏–Ω–∏–π
                            )
                        )
                    )
                    .padding(24.dp)
            ) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(SpacingXL)
                ) {
                    // Header
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.spacedBy(SpacingM)
                    ) {
                        Text(
                            text = mode.icon,
                            fontSize = 40.sp
                        )
                        
                        Text(
                            text = mode.title,
                            fontSize = 18.sp,
                            fontWeight = FontWeight.Bold,
                            color = mode.titleColor,
                            textAlign = TextAlign.Center
                        )
                        
                    if (mode.instructions.isNotEmpty()) {
                        Text(
                            text = mode.instructions,
                            fontSize = 13.sp,
                            color = TextSecondary,
                            textAlign = TextAlign.Center
                        )
                    }
                }
                
                // Info card: What to scan?
                Column(
                    modifier = Modifier
                        .padding(horizontal = SpacingM)
                        .background(
                            Color(0xFFFCD34D).copy(alpha = 0.15f),
                            RoundedCornerShape(8.dp)
                        )
                        .border(1.dp, Color(0xFFFCD34D), RoundedCornerShape(8.dp))
                        .padding(SpacingM),
                    verticalArrangement = Arrangement.spacedBy(SpacingS)
                ) {
                    Text(
                        text = "üí° –ß—Ç–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å?",
                        fontSize = 13.sp,
                        fontWeight = FontWeight.SemiBold,
                        color = Color(0xFFFCD34D)
                    )
                    
                    Column(
                        verticalArrangement = Arrangement.spacedBy(4.dp)
                    ) {
                        Text(
                            text = "QR #1: –î–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —Å–µ–º—å–µ",
                            fontSize = 12.sp,
                            fontWeight = FontWeight.SemiBold,
                            color = Color.White
                        )
                        Text(
                            text = "(–ü–æ–ø—Ä–æ—Å–∏—Ç–µ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –î–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞)",
                            fontSize = 11.sp,
                            color = TextSecondary
                        )
                        
                        Spacer(modifier = Modifier.height(8.dp))
                        
                        Text(
                            text = "QR #2: –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞",
                            fontSize = 12.sp,
                            fontWeight = FontWeight.SemiBold,
                            color = Color.White
                        )
                        Text(
                            text = "(–í–∞—à —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–æ–¥ –∏–∑ iCloud/Email/–°–∫—Ä–∏–Ω—à–æ—Ç–∞)",
                            fontSize = 11.sp,
                            color = TextSecondary
                        )
                    }
                }
                
                // Camera preview with scan frame
                    Box(
                        modifier = Modifier
                            .size(280.dp)
                            .background(Color.Black, RoundedCornerShape(16.dp)),
                        contentAlignment = Alignment.Center
                    ) {
                        // Camera preview
                        CameraPreview(onQRCodeDetected = onCodeScanned)
                        
                        // Scan frame overlay
                        Box(
                            modifier = Modifier
                                .size(180.dp)
                                .border(
                                    width = 3.dp,
                                    color = Color(0xFFFCD34D),  // –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞ –∏–∑ –∏–∫–æ–Ω–∫–∏!
                                    shape = RoundedCornerShape(12.dp)
                                )
                        )
                    }
                    
                    Text(
                        text = "–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥",
                        fontSize = 14.sp,
                        color = TextSecondary
                    )
                    
                    // Divider
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Box(modifier = Modifier.weight(1f).height(1.dp).background(TextTertiary))
                        Text("–∏–ª–∏", fontSize = 12.sp, color = TextSecondary)
                        Box(modifier = Modifier.weight(1f).height(1.dp).background(TextTertiary))
                    }
                    
                    // Manual input button
                    SecondaryButton(
                        text = "üî§ –í–í–ï–°–¢–ò –ö–û–î –í–†–£–ß–ù–£–Æ",
                        onClick = { showManualInput = true }
                    )
                    
                    // Back button
                    Text(
                        text = "–ù–ê–ó–ê–î",
                        fontSize = 14.sp,
                        color = TextSecondary,
                        modifier = Modifier.clickable(onClick = onDismiss)
                    )
                }
            }
        }
    }
    
    if (showManualInput) {
        ManualCodeInputModal(
            onCodeEntered = onCodeScanned,
            onDismiss = { showManualInput = false }
        )
    }
}

// MARK: - QR Scan Mode

enum class QRScanMode(
    val icon: String,
    val title: String,
    val instructions: String,
    val titleColor: Color
) {
    JOIN_FAMILY(
        icon = "üì∑",
        title = "–ü–†–ò–°–û–ï–î–ò–ù–ò–¢–¨–°–Ø –ö –°–ï–ú–¨–ï",
        instructions = "–ü–æ–ø—Ä–æ—Å–∏—Ç–µ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏ –ø–æ–∫–∞–∑–∞—Ç—å QR-–∫–æ–¥:\n–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –°–µ–º—å—è ‚Üí \"–î–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞\"",
        titleColor = Color(0xFFFCD34D)
    ),
    RECOVERY_FROM_FAMILY(
        icon = "üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
        title = "–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ß–ï–†–ï–ó –°–ï–ú–¨–Æ",
        instructions = "–ü–æ–ø—Ä–æ—Å–∏—Ç–µ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏:\n1. –û—Ç–∫—Ä—ã—Ç—å ALADDIN\n2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –°–µ–º—å—è\n3. \"–î–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ —Å–µ–º—å–∏\"\n4. –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞–º QR-–∫–æ–¥",
        titleColor = Color(0xFF10B981)
    ),
    RECOVERY_QR(
        icon = "üîë",
        title = "–°–ö–ê–ù–ò–†–û–í–ê–¢–¨ –ö–û–î –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø",
        instructions = "–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π QR-–∫–æ–¥\n(—Å–∫—Ä–∏–Ω—à–æ—Ç, –ø–µ—á–∞—Ç—å, email)",
        titleColor = Color(0xFF60A5FA)
    )
}

// MARK: - Camera Preview

@Composable
fun CameraPreview(
    onQRCodeDetected: (String) -> Unit
) {
    val context = LocalContext.current
    val lifecycleOwner = LocalLifecycleOwner.current
    val cameraProviderFuture = remember { ProcessCameraProvider.getInstance(context) }
    
    AndroidView(
        factory = { ctx ->
            val previewView = PreviewView(ctx)
            val cameraExecutor: ExecutorService = Executors.newSingleThreadExecutor()
            
            cameraProviderFuture.addListener({
                val cameraProvider = cameraProviderFuture.get()
                
                val preview = Preview.Builder().build().also {
                    it.setSurfaceProvider(previewView.surfaceProvider)
                }
                
                val imageAnalysis = ImageAnalysis.Builder()
                    .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)
                    .build()
                    .also {
                        it.setAnalyzer(cameraExecutor, QRCodeAnalyzer { qrCode ->
                            onQRCodeDetected(qrCode)
                        })
                    }
                
                val cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA
                
                try {
                    cameraProvider.unbindAll()
                    cameraProvider.bindToLifecycle(
                        lifecycleOwner,
                        cameraSelector,
                        preview,
                        imageAnalysis
                    )
                } catch (e: Exception) {
                    e.printStackTrace()
                }
            }, ContextCompat.getMainExecutor(ctx))
            
            previewView
        },
        modifier = Modifier.fillMaxSize()
    )
}

// MARK: - QR Code Analyzer

class QRCodeAnalyzer(
    private val onQRCodeDetected: (String) -> Unit
) : ImageAnalysis.Analyzer {
    
    private val scanner = BarcodeScanning.getClient(
        BarcodeScannerOptions.Builder()
            .setBarcodeFormats(Barcode.FORMAT_QR_CODE)
            .build()
    )
    
    @androidx.camera.core.ExperimentalGetImage
    override fun analyze(imageProxy: ImageProxy) {
        val mediaImage = imageProxy.image
        if (mediaImage != null) {
            val image = InputImage.fromMediaImage(mediaImage, imageProxy.imageInfo.rotationDegrees)
            
            scanner.process(image)
                .addOnSuccessListener { barcodes ->
                    for (barcode in barcodes) {
                        barcode.rawValue?.let { qrCode ->
                            onQRCodeDetected(qrCode)
                        }
                    }
                }
                .addOnCompleteListener {
                    imageProxy.close()
                }
        } else {
            imageProxy.close()
        }
    }
}

// MARK: - Manual Code Input Modal

@Composable
fun ManualCodeInputModal(
    onCodeEntered: (String) -> Unit,
    onDismiss: () -> Unit
) {
    var codePart1 by remember { mutableStateOf("FAM") }
    var codePart2 by remember { mutableStateOf("") }
    var codePart3 by remember { mutableStateOf("") }
    var codePart4 by remember { mutableStateOf("") }
    
    Dialog(onDismissRequest = onDismiss) {
        Card(
            modifier = Modifier
                .width(340.dp)
                .wrapContentHeight(),
            shape = RoundedCornerShape(24.dp),
            colors = CardDefaults.cardColors(containerColor = Color.Transparent)
        ) {
            Box(
                modifier = Modifier
                    .background(
                        Brush.linearGradient(
                            colors = listOf(
                                Color(0xFF0F172A),
                                Color(0xFF1E3A8A),
                                Color(0xFF3B82F6),
                                Color(0xFF1E40AF)
                            )
                        )
                    )
                    .padding(24.dp)
            ) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(SpacingXL)
                ) {
                    Text(
                        text = "üî§",
                        fontSize = 40.sp
                    )
                    
                    Text(
                        text = "–í–í–ï–î–ò–¢–ï –ö–û–î –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø",
                        fontSize = 18.sp,
                        fontWeight = FontWeight.Bold,
                        color = Color(0xFFFCD34D),  // –Ø—Ä–∫–æ–µ –∑–æ–ª–æ—Ç–æ!
                        textAlign = TextAlign.Center
                    )
                    
                    // Code input segments
                    Row(
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        CodeSegmentField(value = codePart1, onValueChange = {}, enabled = false, width = 50.dp)
                        Text("-", color = TextSecondary)
                        CodeSegmentField(value = codePart2, onValueChange = { codePart2 = it }, width = 60.dp)
                        Text("-", color = TextSecondary)
                        CodeSegmentField(value = codePart3, onValueChange = { codePart3 = it }, width = 60.dp)
                        Text("-", color = TextSecondary)
                        CodeSegmentField(value = codePart4, onValueChange = { codePart4 = it }, width = 60.dp)
                    }
                    
                    // Submit button
                    androidx.compose.material3.Button(
                        onClick = {
                            val fullCode = "$codePart1-$codePart2-$codePart3-$codePart4"
                            onCodeEntered(fullCode)
                        },
                        enabled = codePart2.length >= 4 && codePart3.length >= 4 && codePart4.length >= 4,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text("–í–û–°–°–¢–ê–ù–û–í–ò–¢–¨")
                    }
                    
                    // Hint
                    Column(
                        verticalArrangement = Arrangement.spacedBy(4.dp)
                    ) {
                        Text(
                            text = "üí° –ö–æ–¥ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏:",
                            fontSize = 12.sp,
                            color = TextSecondary
                        )
                        Text("‚Ä¢ –í –ø–∏—Å—å–º–µ –Ω–∞ email", fontSize = 12.sp, color = TextTertiary)
                        Text("‚Ä¢ –í —Å–∫—Ä–∏–Ω—à–æ—Ç–µ", fontSize = 12.sp, color = TextTertiary)
                        Text("‚Ä¢ –í –æ–±–ª–∞—á–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ", fontSize = 12.sp, color = TextTertiary)
                        Text("‚Ä¢ –ü–æ–ø—Ä–æ—Å–∏—Ç—å —É –¥—Ä—É–≥–∏—Ö —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏", fontSize = 12.sp, color = TextTertiary)
                    }
                    
                    Text(
                        text = "–ù–ê–ó–ê–î",
                        fontSize = 14.sp,
                        color = TextSecondary,
                        modifier = Modifier.clickable(onClick = onDismiss)
                    )
                }
            }
        }
    }
}

@Composable
fun CodeSegmentField(
    value: String,
    onValueChange: (String) -> Unit,
    enabled: Boolean = true,
    width: Dp = 70.dp
) {
    androidx.compose.material3.OutlinedTextField(
        value = value,
        onValueChange = { if (it.length <= 4) onValueChange(it.uppercase()) },
        enabled = enabled,
        singleLine = true,
        textStyle = androidx.compose.ui.text.TextStyle(
            fontSize = 20.sp,
            fontWeight = FontWeight.Bold,
            fontFamily = androidx.compose.ui.text.font.FontFamily.Monospace,
            color = Color.White,
            textAlign = TextAlign.Center
        ),
        modifier = Modifier
            .width(width)
            .height(56.dp),
        colors = androidx.compose.material3.OutlinedTextFieldDefaults.colors(
            focusedBorderColor = Color(0xFF60A5FA),  // –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π —Å–∏–Ω–∏–π!
            unfocusedBorderColor = Color.White.copy(alpha = 0.2f),
            disabledBorderColor = Color.White.copy(alpha = 0.1f),
            focusedContainerColor = Color(0xFF60A5FA).copy(alpha = 0.1f),
            unfocusedContainerColor = Color.White.copy(alpha = 0.05f),
            disabledContainerColor = Color.White.copy(alpha = 0.05f)
        )
    )
}

