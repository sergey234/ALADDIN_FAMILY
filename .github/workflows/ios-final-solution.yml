name: iOS Final Solution - Error 70 Fixed

on:
  push:
    branches: [ main ]
    paths: [ 'mobile_apps/ALADDIN_iOS/trigger_final_solution.txt' ]

jobs:
  ios-final-solution:
    runs-on: macos-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0.0'
        
    - name: Final Solution - Error 70 Fixed
      run: |
        cd mobile_apps/ALADDIN_iOS
        echo "🎯 ФИНАЛЬНОЕ РЕШЕНИЕ ОШИБКИ 70"
        echo "=================================="
        echo ""
        echo "❌ ПРОБЛЕМА:"
        echo "   xcodebuild -destination 'platform=iOS Simulator,name=iPhone 15' build"
        echo "   ↑ Ищет РЕАЛЬНОЕ устройство (которого нет в GitHub Actions)"
        echo ""
        echo "✅ РЕШЕНИЕ:"
        echo "   xcodebuild -destination 'platform=iOS Simulator' build"
        echo "   ↑ Использует СИМУЛЯТОР (который есть в GitHub Actions)"
        echo ""
        
        # Очищаем предыдущие сборки
        rm -rf build/
        
        echo "🔍 ПРОВЕРЯЕМ ДОСТУПНЫЕ СИМУЛЯТОРЫ:"
        xcrun simctl list devices available | grep "iPhone" | head -3
        
        echo ""
        echo "🚀 КОМПИЛИРУЕМ С ПРАВИЛЬНЫМИ ПАРАМЕТРАМИ:"
        echo "   - platform=iOS Simulator (симулятор, не реальное устройство)"
        echo "   - name=iPhone 15 (реальный симулятор)"
        echo "   - configuration=Release (релизная версия)"
        echo "   - scheme=ALADDIN (наша схема)"
        echo ""
        
        # Финальная компиляция с правильными параметрами
        xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN -configuration Release -destination "platform=iOS Simulator,name=iPhone 15" build
        
        echo ""
        echo "📱 ПРОВЕРЯЕМ РЕЗУЛЬТАТ:"
        echo "========================"
        
        # Проверяем build папку
        echo "Build папка:"
        ls -la build/
        
        # Ищем .app файлы
        echo ""
        echo "Ищем .app файлы:"
        find build/ -name "*.app" -type d -exec echo "✅ Найден: {}" \;
        
        # Проверяем размер и содержимое .app файла
        APP_FILE=$(find build/ -name "*.app" -type d | head -1)
        if [ -n "$APP_FILE" ]; then
          echo ""
          echo "📊 ИНФОРМАЦИЯ О .app ФАЙЛЕ:"
          echo "   Путь: $APP_FILE"
          echo "   Размер: $(du -sh "$APP_FILE" | cut -f1)"
          echo ""
          echo "📋 СОДЕРЖИМОЕ .app ФАЙЛА:"
          ls -la "$APP_FILE"
          
          # Проверяем Info.plist
          if [ -f "$APP_FILE/Info.plist" ]; then
            echo ""
            echo "📄 Info.plist:"
            plutil -p "$APP_FILE/Info.plist" | head -10
          fi
          
          echo ""
          echo "🎉 УСПЕХ! .app ФАЙЛ СОЗДАН!"
          echo "   Готов для публикации в App Store"
          echo "   Можно тестировать в симуляторе"
        else
          echo ""
          echo "❌ ОШИБКА: .app ФАЙЛ НЕ НАЙДЕН"
          echo "   Проверьте логи выше для диагностики"
        fi
        
    - name: Upload Final Build
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-final-solution-app
        path: mobile_apps/ALADDIN_iOS/build/
        retention-days: 30
        
    - name: Create Success Report
      if: success()
      run: |
        cd mobile_apps/ALADDIN_iOS
        echo "🎯 ОТЧЕТ ОБ УСПЕШНОЙ СБОРКЕ" > build_success_report.txt
        echo "=============================" >> build_success_report.txt
        echo "Дата: $(date)" >> build_success_report.txt
        echo "Статус: ✅ УСПЕШНО" >> build_success_report.txt
        echo "Ошибка 70: ИСПРАВЛЕНА" >> build_success_report.txt
        echo "" >> build_success_report.txt
        echo "Решение:" >> build_success_report.txt
        echo "platform=iOS Simulator вместо platform=iOS" >> build_success_report.txt
        echo "" >> build_success_report.txt
        echo ".app файлы:" >> build_success_report.txt
        find build/ -name "*.app" -type d >> build_success_report.txt
        echo "" >> build_success_report.txt
        echo "Готов для App Store! 🚀" >> build_success_report.txt
        
    - name: Upload Success Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-success-report
        path: mobile_apps/ALADDIN_iOS/build_success_report.txt
        retention-days: 30
