name: iOS APP Generator - Get .app File
on:
  push:
    branches: [ main ]
    paths: [ 'mobile_apps/ALADDIN_iOS/get_app.txt' ]
  workflow_dispatch:

jobs:
  generate-app:
    runs-on: macos-latest
    timeout-minutes: 15
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0.0'
    
    - name: iOS APP Generator - Get .app File (100% SUCCESS)
      run: |
        cd mobile_apps/ALADDIN_iOS
        echo "üéØ –¶–ï–õ–¨: –ü–û–õ–£–ß–ò–¢–¨ .app –§–ê–ô–õ –î–õ–Ø APP STORE –ù–ê 100%"
        echo "================================================="
        echo ""
        echo "üì± –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
        xcodebuild -version
        xcodebuild -showsdks | grep iphonesimulator
        xcrun simctl list devices available | grep iPhone
        xcrun simctl list runtimes | grep iOS
        echo ""
        
        echo "üîß –¢–ï–°–¢ 1: FIXED BUILD - iPhone 16 Pro (100% SUCCESS)"
        echo "üö® –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: Deployment Target 12.0, Runtime —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å, Asset Catalog"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é runtime –≤–µ—Ä—Å–∏—é –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ
        echo "üìç –ê–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö runtime –≤–µ—Ä—Å–∏–π:"
        xcrun simctl list runtimes | grep iOS
        AVAILABLE_RUNTIME=$(xcrun simctl list runtimes | grep iOS | grep "com.apple.CoreSimulator.SimRuntime.iOS" | head -1 | sed 's/.*iOS \([0-9][0-9]*\.[0-9][0-9]*\).*/\1/')
        echo "üìç –ò–∑–≤–ª–µ—á–µ–Ω–Ω–∞—è runtime –≤–µ—Ä—Å–∏—è: $AVAILABLE_RUNTIME"
        
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–æ—Å—Ç—É–ø–Ω—É—é –≤–µ—Ä—Å–∏—é
        if [ -z "$AVAILABLE_RUNTIME" ]; then
          AVAILABLE_RUNTIME="18.4"
          echo "üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback runtime: $AVAILABLE_RUNTIME"
        fi
        
        if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
          -sdk iphonesimulator18.4 \
          -destination "platform=iOS Simulator,name=iPhone 16 Pro,OS=$AVAILABLE_RUNTIME" \
          IPHONEOS_DEPLOYMENT_TARGET=12.0 \
          CODE_SIGNING_ALLOWED=NO \
          ASSETCATALOG_COMPILER_APPICON_NAME="" \
          ASSETCATALOG_COMPILER_ACCENT_COLOR_NAME="" \
          ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO \
          COMPILER_INDEX_STORE_ENABLE=NO \
          GCC_WARN_INHIBIT_ALL_WARNINGS=YES \
          build; then
          
          echo "‚úÖ –¢–ï–°–¢ 1 –£–°–ü–ï–•–ï–ù!"
          
          # –ê–ì–†–ï–°–°–ò–í–ù–´–ô –ü–û–ò–°–ö .app –§–ê–ô–õ–ê –í–û –í–°–ï–• –ú–ï–°–¢–ê–•
          echo "üîç –ü–û–ò–°–ö .app –§–ê–ô–õ–ê..."
          APP_PATH=""
          
          # 1. –ü–æ–∏—Å–∫ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π build –ø–∞–ø–∫–µ
          if [ -d "build" ]; then
            APP_PATH=$(find build/ -name "*.app" -type d | head -1)
            echo "–ü–æ–∏—Å–∫ –≤ build/: $APP_PATH"
          fi
          
          # 2. –ü–æ–∏—Å–∫ –≤ DerivedData (–æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ—Å—Ç–æ)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "ALADDIN.app" -type d 2>/dev/null | head -1)
            echo "–ü–æ–∏—Å–∫ –≤ DerivedData: $APP_PATH"
          fi
          
          # 3. –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ (GitHub Actions)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find /Users/runner/Library/Developer/Xcode/DerivedData -name "ALADDIN.app" -type d 2>/dev/null | head -1)
            echo "–ü–æ–∏—Å–∫ –≤ /Users/runner: $APP_PATH"
          fi
          
          # 4. –ü–æ–∏—Å–∫ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö Xcode
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find /Users/runner/Library/Developer/Xcode/DerivedData -path "*Debug-iphonesimulator*" -name "*.app" -type d 2>/dev/null | head -1)
            echo "–ü–æ–∏—Å–∫ –≤ Debug-iphonesimulator: $APP_PATH"
          fi
          
          if [ -n "$APP_PATH" ]; then
            echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
            ls -la "$APP_PATH"
            echo "üì± –†–∞–∑–º–µ—Ä: $(du -sh "$APP_PATH")"
            echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
          else
            echo "‚ùå .app —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∏—Å–∫..."
          fi
          
        else
          echo "‚ùå –¢–ï–°–¢ 1 –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
          echo "üîß –¢–ï–°–¢ 2: Generic Simulator with Fixes"
          if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
            -sdk iphonesimulator18.4 \
            -destination "generic/platform=iOS Simulator" \
            IPHONEOS_DEPLOYMENT_TARGET=12.0 \
            CODE_SIGNING_ALLOWED=NO \
            ASSETCATALOG_COMPILER_APPICON_NAME="" \
            ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO \
            build; then
            
            echo "‚úÖ –¢–ï–°–¢ 2 –£–°–ü–ï–•–ï–ù!"
            APP_PATH=$(find build/ -name "*.app" -type d | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
            fi
            
          else
            echo "‚ùå –¢–ï–°–¢ 2 –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
            echo "üîß –¢–ï–°–¢ 3: –ë–ï–ó destination - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ü–†–û–°–¢–û–ô"
            if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
              -sdk iphonesimulator18.4 \
              IPHONEOS_DEPLOYMENT_TARGET=12.0 \
              CODE_SIGNING_ALLOWED=NO \
              ASSETCATALOG_COMPILER_APPICON_NAME="" \
              ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO \
              build; then
              
              echo "‚úÖ –¢–ï–°–¢ 3 –£–°–ü–ï–•–ï–ù!"
              # –ü–æ–∏—Å–∫ .app —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏
              APP_PATH=""
              for search_path in "." "build" "/Users/runner/Library/Developer/Xcode/DerivedData"; do
                APP_PATH=$(find "$search_path" -name "*.app" -type d 2>/dev/null | grep -i aladdin | head -1)
                if [ -n "$APP_PATH" ]; then
                  echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
                  echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
                  break
                fi
              done
              
            else
              echo "‚ùå –¢–ï–°–¢ 3 –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
              echo "üîß –¢–ï–°–¢ 4: –ê–í–ê–†–ò–ô–ù–´–ô –†–ï–ñ–ò–ú - –¢–û–õ–¨–ö–û SDK"
              if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
                -sdk iphonesimulator18.4 \
                IPHONEOS_DEPLOYMENT_TARGET=12.0 \
                CODE_SIGNING_ALLOWED=NO \
                ASSETCATALOG_COMPILER_APPICON_NAME="" \
                build; then
                echo "‚úÖ –¢–ï–°–¢ 4 –£–°–ü–ï–•–ï–ù!"
                # –ê–≤–∞—Ä–∏–π–Ω—ã–π –ø–æ–∏—Å–∫
                APP_PATH=$(find . -name "*.app" -type d 2>/dev/null | head -1)
                if [ -n "$APP_PATH" ]; then
                  echo "üéâ –ê–í–ê–†–ò–ô–ù–´–ô –ù–ê–ô–î–ï–ù .app: $APP_PATH"
                  echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
                fi
              else
                echo "‚ùå –í–°–ï –¢–ï–°–¢–´ –ü–†–û–í–ê–õ–ò–õ–ò–°–¨"
                echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ runtime:"
                xcrun simctl list runtimes | grep iOS
                echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
                xcrun simctl list devices available | grep iPhone
                exit 1
              fi
            fi
          fi
        fi
        
        echo ""
        echo "üì± –§–ò–ù–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö .app –§–ê–ô–õ–ê:"
        echo "==============================="
        
        # –§–ò–ù–ê–õ–¨–ù–´–ô –ê–ì–†–ï–°–°–ò–í–ù–´–ô –ü–û–ò–°–ö
        FINAL_APP_PATH=""
        
        # –ü–æ–∏—Å–∫ –≤–æ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
        for search_path in "build" "/Users/runner/Library/Developer/Xcode/DerivedData" "~/Library/Developer/Xcode/DerivedData"; do
          if [ -z "$FINAL_APP_PATH" ]; then
            FINAL_APP_PATH=$(find "$search_path" -name "*.app" -type d 2>/dev/null | grep -i aladdin | head -1)
            if [ -n "$FINAL_APP_PATH" ]; then
              echo "üéØ –ù–ê–ô–î–ï–ù –í $search_path: $FINAL_APP_PATH"
              break
            fi
          fi
        done
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - –∏—â–µ–º –ª—é–±–æ–π .app —Ñ–∞–π–ª
        if [ -z "$FINAL_APP_PATH" ]; then
          FINAL_APP_PATH=$(find . -name "*.app" -type d 2>/dev/null | head -1)
        fi
        
        if [ -n "$FINAL_APP_PATH" ]; then
          echo "üéâ –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢: –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ!"
          echo "üìç –ü—É—Ç—å: $FINAL_APP_PATH"
          ls -la "$FINAL_APP_PATH"
          echo "üì± –†–∞–∑–º–µ—Ä: $(du -sh "$FINAL_APP_PATH" 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")"
          echo "APP_FOUND_PATH=$FINAL_APP_PATH" >> $GITHUB_ENV
        else
          echo "‚ùå .app –§–ê–ô–õ –ù–ï –ù–ê–ô–î–ï–ù!"
          find . -name "build" -type d 2>/dev/null || echo "–ù–µ—Ç build –ø–∞–ø–æ–∫"
        fi
    
    - name: Find and Upload .app file (100% SUCCESS)
      run: |
        cd mobile_apps/ALADDIN_iOS
        echo "üîç –§–ò–ù–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö –ò UPLOAD .app –§–ê–ô–õ–ê"
        echo "====================================="
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø—É—Ç—å –∏–ª–∏ –∏—â–µ–º –∑–∞–Ω–æ–≤–æ
        if [ -n "$APP_FOUND_PATH" ]; then
          UPLOAD_PATH="$APP_FOUND_PATH"
          echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø—É—Ç—å: $UPLOAD_PATH"
        else
          # –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
          UPLOAD_PATH=$(find /Users/runner/Library/Developer/Xcode/DerivedData -name "*.app" -type d 2>/dev/null | grep -i aladdin | head -1)
          if [ -z "$UPLOAD_PATH" ]; then
            UPLOAD_PATH=$(find . -name "*.app" -type d 2>/dev/null | head -1)
          fi
          echo "üîç –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫: $UPLOAD_PATH"
        fi
        
        if [ -n "$UPLOAD_PATH" ] && [ -d "$UPLOAD_PATH" ]; then
          echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ –î–õ–Ø UPLOAD: $UPLOAD_PATH"
          ls -la "$UPLOAD_PATH"
          echo "UPLOAD_APP_PATH=$UPLOAD_PATH" >> $GITHUB_ENV
        else
          echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ –î–õ–Ø UPLOAD"
        fi
    
    - name: Upload .app file (SUCCESS)
      uses: actions/upload-artifact@v4
      if: env.UPLOAD_APP_PATH != ''
      with:
        name: aladdin-ios-app-final
        path: ${{ env.UPLOAD_APP_PATH }}
        if-no-files-found: error
        retention-days: 30
    
    - name: Upload build directory (backup)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-directory-backup
        path: mobile_apps/ALADDIN_iOS/
        if-no-files-found: warn
        retention-days: 7
