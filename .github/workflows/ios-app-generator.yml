name: iOS APP Generator - Get .app File
on:
  push:
    branches: [ main ]
    paths: [ 'mobile_apps/ALADDIN_iOS/get_app.txt' ]
  workflow_dispatch:

jobs:
  generate-app:
    runs-on: macos-latest
    timeout-minutes: 15
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0.0'
    
    - name: iOS APP Generator - Get .app File (100% SUCCESS)
      run: |
        cd mobile_apps/ALADDIN_iOS
        echo "üéØ –¶–ï–õ–¨: –ü–û–õ–£–ß–ò–¢–¨ .app –§–ê–ô–õ –î–õ–Ø APP STORE –ù–ê 100%"
        echo "================================================="
        echo ""
        echo "üì± –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
        xcodebuild -version
        xcodebuild -showsdks | grep iphonesimulator
        xcrun simctl list devices available | grep iPhone
        xcrun simctl list runtimes | grep iOS
        echo ""
        
        echo "ü•á –ì–ï–ù–ò–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï 1: –ü–†–ê–í–ò–ú –°–•–ï–ú–£ –ü–†–û–ì–†–ê–ú–ú–ù–û"
        echo "================================================="
        
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ö–µ–º—É ALADDIN –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ iOS Simulator
        echo "üìç –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ö–µ–º—É ALADDIN –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ iOS Simulator..."
        
        # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª —Å—Ö–µ–º—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
        SCHEME_FILE="ALADDIN.xcodeproj/xcshareddata/xcschemes/ALADDIN.xcscheme"
        if [ -f "$SCHEME_FILE" ]; then
          echo "üìç –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª —Å—Ö–µ–º—ã: $SCHEME_FILE"
          
          # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
          cp "$SCHEME_FILE" "$SCHEME_FILE.backup"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É iOS Simulator –≤ —Å—Ö–µ–º—É (–µ—Å–ª–∏ –µ—ë –Ω–µ—Ç)
          if ! grep -q "<MacroExpansion>" "$SCHEME_FILE"; then
            echo "üìç –î–û–ë–ê–í–õ–Ø–ï–ú –ü–û–î–î–ï–†–ñ–ö–£ iOS SIMULATOR –í –°–•–ï–ú–£ - –ì–ï–ù–ò–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï!"
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± - –¥–æ–±–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ echo –∏ sed
            echo "üìç –î–æ–±–∞–≤–ª—è–µ–º MacroExpansion —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
            TEMP_MACRO_FILE="/tmp/macro_addition.txt"
            echo '      <MacroExpansion>' > "$TEMP_MACRO_FILE"
            echo '         <BuildableReference' >> "$TEMP_MACRO_FILE"
            echo '            BuildableIdentifier = "primary"' >> "$TEMP_MACRO_FILE"
            echo '            BlueprintIdentifier = "A0FFFFFD"' >> "$TEMP_MACRO_FILE"
            echo '            BuildableName = "ALADDIN.app"' >> "$TEMP_MACRO_FILE"
            echo '            BlueprintName = "ALADDIN"' >> "$TEMP_MACRO_FILE"
            echo '            ReferencedContainer = "container:ALADDIN.xcodeproj">' >> "$TEMP_MACRO_FILE"
            echo '         </BuildableReference>' >> "$TEMP_MACRO_FILE"
            echo '      </MacroExpansion>' >> "$TEMP_MACRO_FILE"
            
            # –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ BuildableProductRunnable
            sed -i.backup "/<\/BuildableProductRunnable>/r $TEMP_MACRO_FILE" "$SCHEME_FILE"
            rm -f "$TEMP_MACRO_FILE"
            echo "üìç –ú–∞–∫—Ä–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Ö–µ–º—É"
            
            echo "üìç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
            if grep -q "<MacroExpansion>" "$SCHEME_FILE"; then
              echo "‚úÖ –£–°–ü–ï–•! MacroExpansion –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Ö–µ–º—É!"
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ö–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–º—É–ª—è—Ç–æ—Ä
              echo "üìç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ destinations –¥–ª—è —Å—Ö–µ–º—ã..."
              xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN -showsdks 2>/dev/null | head -5 || echo "–°—Ö–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
            else
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å MacroExpansion"
            fi
            
          else
            echo "üìç –°—Ö–µ–º–∞ —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç iOS Simulator (–µ—Å—Ç—å MacroExpansion)"
          fi
        else
          echo "üìç –§–∞–π–ª —Å—Ö–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ö–µ–º—É —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Simulator"
          
          # ü•à –†–ï–®–ï–ù–ò–ï 2: –°–û–ó–î–ê–ï–ú –ù–û–í–£–Æ –°–•–ï–ú–£ –° –ü–û–î–î–ï–†–ñ–ö–û–ô SIMULATOR
          echo "ü•à –ì–ï–ù–ò–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï 2: –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ô –°–•–ï–ú–´"
          echo "=============================================="
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å—Ö–µ–º –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          mkdir -p "ALADDIN.xcodeproj/xcshareddata/xcschemes"
          
          # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ö–µ–º—É ALADDIN-Simulator —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
          echo "üìç –°–æ–∑–¥–∞–µ–º —Å—Ö–µ–º—É ALADDIN-Simulator –¥–ª—è iOS Simulator..."
          
          # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Å—Ö–µ–º—É
          NEW_SCHEME="ALADDIN-Simulator"
        fi
        
        echo "ü•â –†–ï–®–ï–ù–ò–ï 3: –ò–°–ü–û–õ–¨–ó–£–ï–ú –ü–†–û–ï–ö–¢ –ù–ê–ü–†–Ø–ú–£–Æ –ë–ï–ó –°–•–ï–ú–´"
        echo "=================================================="
        echo "üìç –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –Ω–∞–ø—Ä—è–º—É—é, –æ–±—Ö–æ–¥—è –ø—Ä–æ–±–ª–µ–º—ã —Å—Ö–µ–º—ã..."
        
        echo "üîß –¢–ï–°–¢ 1: FIXED BUILD - iPhone 16 Pro (100% SUCCESS)"
        echo "üö® –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: Deployment Target 12.0, Runtime —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å, Asset Catalog, Scheme Fix"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é SDK –≤–µ—Ä—Å–∏—é –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ - –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
        echo "üìç –ê–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö SDK –≤–µ—Ä—Å–∏–π:"
        xcodebuild -showsdks | grep iphonesimulator
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é runtime –≤–µ—Ä—Å–∏—é —Å–Ω–∞—á–∞–ª–∞ - —ç—Ç–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!
        echo "üìç –ê–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö runtime –≤–µ—Ä—Å–∏–π:"
        xcrun simctl list runtimes | grep iOS
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö SDK –≤–µ—Ä—Å–∏–π
        ALL_SDK_VERSIONS=$(xcodebuild -showsdks | grep iphonesimulator | awk '{print $NF}')
        echo "üìç –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ SDK: $ALL_SDK_VERSIONS"
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö runtime –≤–µ—Ä—Å–∏–π
        ALL_RUNTIME_VERSIONS=$(xcrun simctl list runtimes | grep iOS | sed 's/.*iOS \([0-9][0-9]*\.[0-9][0-9]*\).*/\1/' | sort -V)
        echo "üìç –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ runtime: $ALL_RUNTIME_VERSIONS"
        
        # –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê: —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–∏—Ä–∞–µ–º SDK, –ø–æ—Ç–æ–º –∏—â–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π runtime - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï!
        AVAILABLE_SDK=""
        AVAILABLE_RUNTIME=""
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ë–µ—Ä–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–π SDK (–æ–±—ã—á–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω)
        AVAILABLE_SDK=$(echo "$ALL_SDK_VERSIONS" | head -1)
        echo "üìç –í—ã–±—Ä–∞–Ω SDK: $AVAILABLE_SDK"
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò—â–µ–º runtime —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º SDK
        # –ò–∑–≤–ª–µ–∫–∞–µ–º major.minor –≤–µ—Ä—Å–∏—é SDK
        SDK_VERSION=$(echo "$AVAILABLE_SDK" | sed 's/iphonesimulator\([0-9][0-9]*\.[0-9][0-9]*\).*/\1/')
        SDK_MAJOR=$(echo "$SDK_VERSION" | cut -d. -f1)
        echo "üìç –í–µ—Ä—Å–∏—è SDK: $SDK_VERSION (major: $SDK_MAJOR)"
        
        # –ò—â–µ–º runtime —Ç–æ–≥–æ –∂–µ major –≤–µ—Ä—Å–∏–∏ —á—Ç–æ –∏ SDK
        COMPATIBLE_RUNTIMES=$(echo "$ALL_RUNTIME_VERSIONS" | grep "^$SDK_MAJOR\." || echo "")
        if [ -n "$COMPATIBLE_RUNTIMES" ]; then
          # –ë–µ—Ä–µ–º —Å–∞–º—É—é –Ω–æ–≤—É—é runtime —Ç–æ–π –∂–µ major –≤–µ—Ä—Å–∏–∏
          AVAILABLE_RUNTIME=$(echo "$COMPATIBLE_RUNTIMES" | tail -1)
          echo "üìç –ù–∞–π–¥–µ–Ω —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π runtime –¥–ª—è SDK $SDK_VERSION: $AVAILABLE_RUNTIME"
        else
          # Fallback: –±–µ—Ä–µ–º –ª—é–±—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é runtime, –Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
          AVAILABLE_RUNTIME=$(echo "$ALL_RUNTIME_VERSIONS" | head -1)
          echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ –Ω–∞–π–¥–µ–Ω runtime –≤–µ—Ä—Å–∏–∏ $SDK_MAJOR.x, –∏—Å–ø–æ–ª—å–∑—É–µ–º $AVAILABLE_RUNTIME"
        fi
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ - fallback
        if [ -z "$AVAILABLE_SDK" ]; then
          AVAILABLE_SDK="iphonesimulator18.0"
          echo "üìç Fallback SDK: $AVAILABLE_SDK"
        fi
        if [ -z "$AVAILABLE_RUNTIME" ]; then
          AVAILABLE_RUNTIME="18.4"
          echo "üìç Fallback Runtime: $AVAILABLE_RUNTIME"
        fi
        
        echo "üìç –§–ò–ù–ê–õ–¨–ù–´–ô –í–´–ë–û–†: SDK=$AVAILABLE_SDK, Runtime=$AVAILABLE_RUNTIME"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫—É—é —Å—Ö–µ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
        if [ -n "$NEW_SCHEME" ]; then
          SCHEME_NAME="$NEW_SCHEME"
        else
          SCHEME_NAME="ALADDIN"
        fi
        echo "üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è —Å—Ö–µ–º–∞: $SCHEME_NAME"
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å Asset Catalog - –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
        ASSET_FLAGS=""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å SDK –∏ Runtime –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
        SDK_MAJOR_FINAL=$(echo "$AVAILABLE_SDK" | sed 's/iphonesimulator\([0-9][0-9]*\).*/\1/')
        RUNTIME_MAJOR_FINAL=$(echo "$AVAILABLE_RUNTIME" | cut -d. -f1)
        
        echo "üìç –ü–†–û–í–ï–†–ö–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò: SDK major=$SDK_MAJOR_FINAL, Runtime major=$RUNTIME_MAJOR_FINAL"
        
        if [ "$SDK_MAJOR_FINAL" != "$RUNTIME_MAJOR_FINAL" ]; then
          echo "‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò: SDK $SDK_MAJOR_FINAL –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º —Å Runtime $RUNTIME_MAJOR_FINAL"
          echo "üìç –ò—â–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π runtime –¥–ª—è SDK $SDK_MAJOR_FINAL..."
          
          # –ò—â–µ–º runtime —Ç–æ–π –∂–µ major –≤–µ—Ä—Å–∏–∏ —á—Ç–æ –∏ SDK
          CORRECT_RUNTIME=$(echo "$ALL_RUNTIME_VERSIONS" | grep "^$SDK_MAJOR_FINAL\." | head -1)
          if [ -n "$CORRECT_RUNTIME" ]; then
            AVAILABLE_RUNTIME="$CORRECT_RUNTIME"
            echo "‚úÖ –ù–ê–ô–î–ï–ù –°–û–í–ú–ï–°–¢–ò–ú–´–ô RUNTIME: $AVAILABLE_RUNTIME"
          else
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π runtime –¥–ª—è SDK $SDK_MAJOR_FINAL"
          fi
        fi
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è Asset Catalog
        if [ "$AVAILABLE_SDK" = "iphonesimulator18.0" ]; then
          ASSET_FLAGS="ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME= ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME=AccentColor"
        fi
        
        # –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê DESTINATION - –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è runtime
        echo "üìç –ê–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ runtime —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:"
        xcrun simctl list devices available | grep iPhone | head -5
        
        # 1. –ò—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π runtime –≤–µ—Ä—Å–∏–∏
        echo "üìç –ü–æ–∏—Å–∫ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å runtime $AVAILABLE_RUNTIME..."
        
        # –ü–æ–ª—É—á–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π runtime
        RUNTIME_DEVICES=$(xcrun simctl list devices | grep -A 50 "$AVAILABLE_RUNTIME" | grep "iPhone" | head -5)
        echo "üìç –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è runtime $AVAILABLE_RUNTIME:"
        echo "$RUNTIME_DEVICES"
        
        # –ò—â–µ–º iPhone 16 Pro –¥–ª—è –¥–∞–Ω–Ω–æ–π runtime
        COMPATIBLE_DEVICE=$(echo "$RUNTIME_DEVICES" | grep "iPhone 16 Pro" | head -1)
        
        if [ -n "$COMPATIBLE_DEVICE" ]; then
          DEVICE_NAME=$(echo "$COMPATIBLE_DEVICE" | cut -d'(' -f1 | xargs)
          echo "üìç –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE_NAME –¥–ª—è runtime $AVAILABLE_RUNTIME"
          # –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –ü–û–î–•–û–î: –ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è OS - –ø—É—Å—Ç—å —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –≤—ã–±–µ—Ä–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é
          DESTINATION_SPEC="platform=iOS Simulator,name=$DEVICE_NAME"
        else
          # 2. –ï—Å–ª–∏ –Ω–µ—Ç iPhone 16 Pro, –±–µ—Ä–µ–º –ª—é–±–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ iPhone –¥–ª—è —ç—Ç–æ–π runtime
          ANY_IPHONE=$(echo "$RUNTIME_DEVICES" | grep "iPhone" | head -1)
          if [ -n "$ANY_IPHONE" ]; then
            DEVICE_NAME=$(echo "$ANY_IPHONE" | cut -d'(' -f1 | xargs)
            echo "üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE_NAME –¥–ª—è runtime $AVAILABLE_RUNTIME"
            # –ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è OS - –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ
            DESTINATION_SPEC="platform=iOS Simulator,name=$DEVICE_NAME"
          else
            # 3. Fallback: generic destination –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è runtime
            echo "üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º generic destination –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è runtime"
            DESTINATION_SPEC="generic/platform=iOS Simulator"
          fi
        fi
        echo "üìç –ò–°–ü–û–õ–¨–ó–£–ï–ú–´–ô DESTINATION: $DESTINATION_SPEC"
        
        if xcodebuild -project ALADDIN.xcodeproj -scheme "$SCHEME_NAME" \
          -sdk "$AVAILABLE_SDK" \
          -destination "$DESTINATION_SPEC" \
          IPHONEOS_DEPLOYMENT_TARGET=12.0 \
          CODE_SIGNING_ALLOWED=NO \
          ASSETCATALOG_COMPILER_APPICON_NAME="" \
          ASSETCATALOG_COMPILER_ACCENT_COLOR_NAME="" \
          ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO \
          COMPILER_INDEX_STORE_ENABLE=NO \
          GCC_WARN_INHIBIT_ALL_WARNINGS=YES \
          $ASSET_FLAGS \
          build; then
          
          echo "‚úÖ –¢–ï–°–¢ 1 –£–°–ü–ï–•–ï–ù!"
          
          # –ê–ì–†–ï–°–°–ò–í–ù–´–ô –ü–û–ò–°–ö .app –§–ê–ô–õ–ê –í–û –í–°–ï–• –ú–ï–°–¢–ê–•
          echo "üîç –ü–û–ò–°–ö .app –§–ê–ô–õ–ê..."
          APP_PATH=""
          
          # 1. –ü–æ–∏—Å–∫ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π build –ø–∞–ø–∫–µ
          if [ -d "build" ]; then
            APP_PATH=$(find build/ -name "*.app" -type d | head -1)
            echo "–ü–æ–∏—Å–∫ –≤ build/: $APP_PATH"
          fi
          
          # 2. –ü–æ–∏—Å–∫ –≤ DerivedData (–æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ—Å—Ç–æ)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "ALADDIN.app" -type d 2>/dev/null | head -1)
            echo "–ü–æ–∏—Å–∫ –≤ DerivedData: $APP_PATH"
          fi
          
          # 3. –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ (GitHub Actions)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find /Users/runner/Library/Developer/Xcode/DerivedData -name "ALADDIN.app" -type d 2>/dev/null | head -1)
            echo "–ü–æ–∏—Å–∫ –≤ /Users/runner: $APP_PATH"
          fi
          
          # 4. –ü–æ–∏—Å–∫ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö Xcode
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find /Users/runner/Library/Developer/Xcode/DerivedData -path "*Debug-iphonesimulator*" -name "*.app" -type d 2>/dev/null | head -1)
            echo "–ü–æ–∏—Å–∫ –≤ Debug-iphonesimulator: $APP_PATH"
          fi
          
          if [ -n "$APP_PATH" ]; then
            echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
            ls -la "$APP_PATH"
            echo "üì± –†–∞–∑–º–µ—Ä: $(du -sh "$APP_PATH")"
            echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
          else
            echo "‚ùå .app —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∏—Å–∫..."
          fi
          
        else
          echo "‚ùå –¢–ï–°–¢ 1 –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
          echo "üîß –¢–ï–°–¢ 2: –ü–æ–ø—Ä–æ–±—É–µ–º —Å ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
          
          # –ü–æ–ª—É—á–∞–µ–º ID –ø–µ—Ä–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ iPhone —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 16 Pro" | head -1 | grep -o '[A-F0-9-]\{36\}')
          TEST2A_SUCCESS=false
          TEST2B_SUCCESS=false
          if [ -n "$DEVICE_ID" ]; then
            echo "üìç –ü–æ–ø—Ä–æ–±—É–µ–º —Å ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: $DEVICE_ID"
            if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
              -sdk "$AVAILABLE_SDK" \
              -destination "platform=iOS Simulator,id=$DEVICE_ID" \
              IPHONEOS_DEPLOYMENT_TARGET=12.0 \
              CODE_SIGNING_ALLOWED=NO \
              ASSETCATALOG_COMPILER_APPICON_NAME="" \
              ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO \
              build; then
              echo "‚úÖ –¢–ï–°–¢ 2A –£–°–ü–ï–•–ï–ù —Å ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞!"
              TEST2A_SUCCESS=true
              APP_PATH=$(find build/ -name "*.app" -type d | head -1)
              if [ -n "$APP_PATH" ]; then
                echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
                echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
              fi
            else
              echo "‚ùå –¢–ï–°–¢ 2A –ù–ï –†–ê–ë–û–¢–ê–ï–¢ —Å ID"
            fi
          fi
          
          if [ "$TEST2A_SUCCESS" != "true" ]; then
            echo "üîß –¢–ï–°–¢ 2B: Generic Simulator with Fixes"
            if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
              -sdk "$AVAILABLE_SDK" \
              -destination "generic/platform=iOS Simulator" \
              IPHONEOS_DEPLOYMENT_TARGET=12.0 \
              CODE_SIGNING_ALLOWED=NO \
              ASSETCATALOG_COMPILER_APPICON_NAME="" \
              ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO \
              build; then
            
              echo "‚úÖ –¢–ï–°–¢ 2B –£–°–ü–ï–•–ï–ù!"
              TEST2B_SUCCESS=true
              APP_PATH=$(find build/ -name "*.app" -type d | head -1)
              if [ -n "$APP_PATH" ]; then
                echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
                echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
              fi
              
            else
              echo "‚ùå –¢–ï–°–¢ 2B –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
            fi
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–µ–ª –ª–∏ –∫–∞–∫–æ–π-—Ç–æ –∏–∑ —Ç–µ—Å—Ç–æ–≤ 2A –∏–ª–∏ 2B
          if [ "$TEST2A_SUCCESS" != "true" ] && [ "$TEST2B_SUCCESS" != "true" ]; then
            echo "üîß –¢–ï–°–¢ 3: –ë–ï–ó destination - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ü–†–û–°–¢–û–ô"
            if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
              -sdk "$AVAILABLE_SDK" \
              IPHONEOS_DEPLOYMENT_TARGET=12.0 \
              CODE_SIGNING_ALLOWED=NO \
              ASSETCATALOG_COMPILER_APPICON_NAME="" \
              ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO \
              build; then
              
              echo "‚úÖ –¢–ï–°–¢ 3 –£–°–ü–ï–•–ï–ù!"
              # –ü–æ–∏—Å–∫ .app —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏
              APP_PATH=""
              for search_path in "." "build" "/Users/runner/Library/Developer/Xcode/DerivedData"; do
                APP_PATH=$(find "$search_path" -name "*.app" -type d 2>/dev/null | grep -i aladdin | head -1)
                if [ -n "$APP_PATH" ]; then
                  echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
                  echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
                  break
                fi
              done
              
            else
              echo "‚ùå –¢–ï–°–¢ 3 –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
              echo "üîß –¢–ï–°–¢ 4: iOS DEVICE SDK - –†–ï–ê–õ–¨–ù–û–ï –£–°–¢–†–û–ô–°–¢–í–û"
              
              # –ë—ã—Å—Ç—Ä–æ –ø—Ä–æ–±—É–µ–º iOS device SDK
              DEVICE_SDK=$(xcodebuild -showsdks | grep iphoneos | awk '{print $NF}' | head -1)
              if [ -n "$DEVICE_SDK" ]; then
                echo "üìç –¢–µ—Å—Ç–∏—Ä—É–µ–º iOS device SDK: $DEVICE_SDK"
                if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
                  -sdk "$DEVICE_SDK" \
                  IPHONEOS_DEPLOYMENT_TARGET=12.0 \
                  CODE_SIGNING_ALLOWED=NO \
                  ASSETCATALOG_COMPILER_APPICON_NAME="" \
                  build; then
                  
                  echo "‚úÖ –¢–ï–°–¢ 4 –£–°–ü–ï–•–ï–ù —Å iOS device SDK!"
                  APP_PATH=$(find . -name "*.app" -type d 2>/dev/null | head -1)
                  if [ -n "$APP_PATH" ]; then
                    echo "üéâ –ù–ê–ô–î–ï–ù .app –¥–ª—è device: $APP_PATH"
                    echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
                  fi
                else
                  echo "‚ùå –¢–ï–°–¢ 4 –ù–ï –†–ê–ë–û–¢–ê–ï–¢ —Å device SDK"
                fi
              fi
              
              echo "üîß –¢–ï–°–¢ 5: –ê–í–ê–†–ò–ô–ù–´–ô –†–ï–ñ–ò–ú - –¢–û–õ–¨–ö–û SDK"
              if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
                -sdk "$AVAILABLE_SDK" \
                IPHONEOS_DEPLOYMENT_TARGET=12.0 \
                CODE_SIGNING_ALLOWED=NO \
                ASSETCATALOG_COMPILER_APPICON_NAME="" \
                build; then
                echo "‚úÖ –¢–ï–°–¢ 5 –£–°–ü–ï–•–ï–ù!"
                # –ê–≤–∞—Ä–∏–π–Ω—ã–π –ø–æ–∏—Å–∫
                APP_PATH=$(find . -name "*.app" -type d 2>/dev/null | head -1)
                if [ -n "$APP_PATH" ]; then
                  echo "üéâ –ê–í–ê–†–ò–ô–ù–´–ô –ù–ê–ô–î–ï–ù .app: $APP_PATH"
                  echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
                fi
              else
                echo "‚ùå –¢–ï–°–¢ 5 –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
                echo "üîß –¢–ï–°–¢ 6: –ü–û–ü–†–û–ë–£–ï–ú ARCHIVE - –ù–û–í–´–ô –ü–û–î–•–û–î"
                
                # –ü–æ–ø—Ä–æ–±—É–µ–º archive –≤–º–µ—Å—Ç–æ build
                if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
                  -sdk "$AVAILABLE_SDK" \
                  -destination "generic/platform=iOS Simulator" \
                  IPHONEOS_DEPLOYMENT_TARGET=12.0 \
                  CODE_SIGNING_ALLOWED=NO \
                  ASSETCATALOG_COMPILER_APPICON_NAME="" \
                  archive -archivePath ./ALADDIN.xcarchive; then
                  
                  echo "‚úÖ –¢–ï–°–¢ 6 –£–°–ü–ï–•–ï–ù —Å archive!"
                  # –ü–æ–∏—Å–∫ .app –≤ –∞—Ä—Ö–∏–≤–µ
                  APP_PATH=$(find ./ALADDIN.xcarchive -name "*.app" -type d 2>/dev/null | head -1)
                  if [ -n "$APP_PATH" ]; then
                    echo "üéâ –ù–ê–ô–î–ï–ù .app –≤ –∞—Ä—Ö–∏–≤–µ: $APP_PATH"
                    echo "APP_FOUND_PATH=$APP_PATH" >> $GITHUB_ENV
                  fi
                else
                  echo "‚ùå –í–°–ï –¢–ï–°–¢–´ –ü–†–û–í–ê–õ–ò–õ–ò–°–¨"
                  echo "–ü—Ä–æ–±–ª–µ–º–∞: –°—Ö–µ–º–∞ ALADDIN –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç iOS Simulator destinations"
                  echo "–ü—Ä–æ–±–æ–≤–∞–ª–∏ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã:"
                  echo "- iOS Simulator —Å —Ä–∞–∑–Ω—ã–º–∏ destination specifiers"
                  echo "- Generic destinations"
                  echo "- ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
                  echo "- Archive approach"
                  echo "- iOS device SDK"
                  echo ""
                  echo "–†–ï–®–ï–ù–ò–ï: –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ö–µ–º—É ALADDIN –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ iOS Simulator –≤ Xcode"
                  xcodebuild -list 2>/dev/null || echo "–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ö–µ–º"
                  exit 1
                fi
              fi
            fi
          fi
        fi
        
        echo ""
        echo "üì± –§–ò–ù–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö .app –§–ê–ô–õ–ê:"
        echo "==============================="
        
        # –§–ò–ù–ê–õ–¨–ù–´–ô –ê–ì–†–ï–°–°–ò–í–ù–´–ô –ü–û–ò–°–ö
        FINAL_APP_PATH=""
        
        # –ü–æ–∏—Å–∫ –≤–æ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
        for search_path in "build" "/Users/runner/Library/Developer/Xcode/DerivedData" "~/Library/Developer/Xcode/DerivedData"; do
          if [ -z "$FINAL_APP_PATH" ]; then
            FINAL_APP_PATH=$(find "$search_path" -name "*.app" -type d 2>/dev/null | grep -i aladdin | head -1)
            if [ -n "$FINAL_APP_PATH" ]; then
              echo "üéØ –ù–ê–ô–î–ï–ù –í $search_path: $FINAL_APP_PATH"
              break
            fi
          fi
        done
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - –∏—â–µ–º –ª—é–±–æ–π .app —Ñ–∞–π–ª
        if [ -z "$FINAL_APP_PATH" ]; then
          FINAL_APP_PATH=$(find . -name "*.app" -type d 2>/dev/null | head -1)
        fi
        
        if [ -n "$FINAL_APP_PATH" ]; then
          echo "üéâ –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢: –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ!"
          echo "üìç –ü—É—Ç—å: $FINAL_APP_PATH"
          ls -la "$FINAL_APP_PATH"
          echo "üì± –†–∞–∑–º–µ—Ä: $(du -sh "$FINAL_APP_PATH" 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")"
          echo "APP_FOUND_PATH=$FINAL_APP_PATH" >> $GITHUB_ENV
        else
          echo "‚ùå .app –§–ê–ô–õ –ù–ï –ù–ê–ô–î–ï–ù!"
          find . -name "build" -type d 2>/dev/null || echo "–ù–µ—Ç build –ø–∞–ø–æ–∫"
        fi
    
    - name: Find and Upload .app file (100% SUCCESS)
      run: |
        cd mobile_apps/ALADDIN_iOS
        echo "üîç –§–ò–ù–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö –ò UPLOAD .app –§–ê–ô–õ–ê"
        echo "====================================="
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø—É—Ç—å –∏–ª–∏ –∏—â–µ–º –∑–∞–Ω–æ–≤–æ
        if [ -n "$APP_FOUND_PATH" ]; then
          UPLOAD_PATH="$APP_FOUND_PATH"
          echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø—É—Ç—å: $UPLOAD_PATH"
        else
          # –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
          UPLOAD_PATH=$(find /Users/runner/Library/Developer/Xcode/DerivedData -name "*.app" -type d 2>/dev/null | grep -i aladdin | head -1)
          if [ -z "$UPLOAD_PATH" ]; then
            UPLOAD_PATH=$(find . -name "*.app" -type d 2>/dev/null | head -1)
          fi
          echo "üîç –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫: $UPLOAD_PATH"
        fi
        
        if [ -n "$UPLOAD_PATH" ] && [ -d "$UPLOAD_PATH" ]; then
          echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ –î–õ–Ø UPLOAD: $UPLOAD_PATH"
          ls -la "$UPLOAD_PATH"
          echo "UPLOAD_APP_PATH=$UPLOAD_PATH" >> $GITHUB_ENV
        else
          echo "‚ùå –ù–ï –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ –î–õ–Ø UPLOAD"
        fi
    
    - name: Upload .app file (SUCCESS)
      uses: actions/upload-artifact@v4
      if: env.UPLOAD_APP_PATH != ''
      with:
        name: aladdin-ios-app-final
        path: ${{ env.UPLOAD_APP_PATH }}
        if-no-files-found: error
        retention-days: 30
    
    - name: Upload build directory (backup)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-directory-backup
        path: mobile_apps/ALADDIN_iOS/
        if-no-files-found: warn
        retention-days: 7

