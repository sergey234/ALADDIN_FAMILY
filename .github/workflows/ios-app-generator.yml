name: iOS APP Generator - Get .app File
on:
  push:
    branches: [ main ]
    paths: [ 'mobile_apps/ALADDIN_iOS/get_app.txt' ]
  workflow_dispatch:

jobs:
  generate-app:
    runs-on: macos-latest
    timeout-minutes: 15
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0.0'
    
    - name: iOS APP Generator - Get .app File
      run: |
        cd mobile_apps/ALADDIN_iOS
        echo "üéØ –¶–ï–õ–¨: –ü–û–õ–£–ß–ò–¢–¨ .app –§–ê–ô–õ –î–õ–Ø APP STORE"
        echo "=========================================="
        echo ""
        echo "üì± –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
        xcodebuild -version
        xcodebuild -showsdks | grep iphonesimulator
        xcrun simctl list devices available | grep iPhone
        echo ""
        
        echo "üîß –¢–ï–°–¢ 1: Fixed Build (—Ä–µ—à–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º)"
        if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
          -sdk iphonesimulator \
          -destination "platform=iOS Simulator,name=iPhone 16 Pro" \
          IPHONEOS_DEPLOYMENT_TARGET=13.0 \
          CODE_SIGNING_ALLOWED=NO \
          ASSETCATALOG_COMPILER_APPICON_NAME="" \
          ASSETCATALOG_COMPILER_ACCENT_COLOR_NAME="" \
          COMPILER_INDEX_STORE_ENABLE=NO \
          GCC_WARN_INHIBIT_ALL_WARNINGS=YES \
          build; then
          
          echo "‚úÖ –¢–ï–°–¢ 1 –£–°–ü–ï–•–ï–ù!"
          # –ü–æ–∏—Å–∫ .app —Ñ–∞–π–ª–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
          APP_PATH=""
          if [ -d "build" ]; then
            APP_PATH=$(find build/ -name "*.app" -type d | head -1)
          fi
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "ALADDIN.app" -type d 2>/dev/null | head -1)
          fi
          if [ -n "$APP_PATH" ]; then
            echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
            ls -la "$APP_PATH"
            echo "üì± –†–∞–∑–º–µ—Ä: $(du -sh "$APP_PATH")"
          fi
          
        else
          echo "‚ùå –¢–ï–°–¢ 1 –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
          echo "üîß –¢–ï–°–¢ 2: Generic Simulator with Fixes"
          if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
            -destination "generic/platform=iOS Simulator" \
            IPHONEOS_DEPLOYMENT_TARGET=13.0 \
            CODE_SIGNING_ALLOWED=NO \
            ASSETCATALOG_COMPILER_APPICON_NAME="" \
            build; then
            
            echo "‚úÖ –¢–ï–°–¢ 2 –£–°–ü–ï–•–ï–ù!"
            APP_PATH=$(find build/ -name "*.app" -type d | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
            fi
            
          else
            echo "‚ùå –¢–ï–°–¢ 2 –ù–ï –†–ê–ë–û–¢–ê–ï–¢"
            echo "üîß –¢–ï–°–¢ 3: –ë–µ–∑ destination —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏"
            if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
              -sdk iphonesimulator \
              IPHONEOS_DEPLOYMENT_TARGET=13.0 \
              CODE_SIGNING_ALLOWED=NO \
              ASSETCATALOG_COMPILER_APPICON_NAME="" \
              build; then
              
              echo "‚úÖ –¢–ï–°–¢ 3 –£–°–ü–ï–•–ï–ù!"
              APP_PATH=$(find build/ -name "*.app" -type d | head -1)
              if [ -n "$APP_PATH" ]; then
                echo "üéâ –ù–ê–ô–î–ï–ù .app –§–ê–ô–õ: $APP_PATH"
              fi
              
            else
              echo "‚ùå –í–°–ï –¢–ï–°–¢–´ –ü–†–û–í–ê–õ–ò–õ–ò–°–¨"
              echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ runtime:"
              xcrun simctl list runtimes | grep iOS
              exit 1
            fi
          fi
        fi
        
        echo ""
        echo "üì± –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:"
        find build/ -name "*.app" -type d || echo "‚ùå .app —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        ls -la build/ || echo "‚ùå build –ø–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    
    - name: Upload .app file
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: aladdin-ios-app
        path: mobile_apps/ALADDIN_iOS/build/*.app
        if-no-files-found: warn
        retention-days: 7
    
    - name: Upload build directory
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-directory
        path: mobile_apps/ALADDIN_iOS/build/
        if-no-files-found: warn
        retention-days: 7
