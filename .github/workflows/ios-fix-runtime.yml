name: iOS Runtime Fix - Get .app File
on:
  push:
    branches: [ main ]
    paths: [ 'mobile_apps/ALADDIN_iOS/fix_runtime.txt' ]
  workflow_dispatch:

jobs:
  fix-runtime-build:
    runs-on: macos-latest
    timeout-minutes: 15
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0.0'
    
    - name: iOS Runtime Fix - All Problems Solved
      run: |
        cd mobile_apps/ALADDIN_iOS
        echo "üéØ –ò–°–ü–†–ê–í–õ–Ø–ï–ú –í–°–ï –ü–†–û–ë–õ–ï–ú–´:"
        echo "============================"
        echo "1. Runtime version compatibility"
        echo "2. Deployment target (11.0 -> 13.0)"
        echo "3. Asset Catalog bypass"
        echo "4. Specific device destination"
        echo ""
        
        echo "üì± –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ runtime:"
        xcrun simctl list runtimes | grep iOS
        
        echo ""
        echo "üîß –†–ï–®–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º iPhone 16 Pro —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"
        
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
        if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
          -destination "platform=iOS Simulator,name=iPhone 16 Pro,OS=18.4" \
          -sdk iphonesimulator \
          IPHONEOS_DEPLOYMENT_TARGET=13.0 \
          CODE_SIGNING_ALLOWED=NO \
          ASSETCATALOG_COMPILER_APPICON_NAME="" \
          ASSETCATALOG_COMPILER_ACCENT_COLOR_NAME="" \
          COMPILER_INDEX_STORE_ENABLE=NO \
          GCC_WARN_INHIBIT_ALL_WARNINGS=YES \
          build; then
          
          echo "‚úÖ –£–°–ü–ï–•! –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã!"
          
          # –ò—â–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π .app —Ñ–∞–π–ª
          echo ""
          echo "üì± –ü–æ–∏—Å–∫ .app —Ñ–∞–π–ª–∞:"
          find . -name "*.app" -type d | head -5
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º build –ø–∞–ø–∫—É
          echo ""
          echo "üìÇ –ü—Ä–æ–≤–µ—Ä—è–µ–º build –ø–∞–ø–∫—É:"
          if [ -d "build" ]; then
            ls -la build/
            find build/ -name "*.app" -type d || echo "–ò—â–µ–º –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö..."
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º DerivedData
          echo ""
          echo "üìÇ –ü—Ä–æ–≤–µ—Ä—è–µ–º DerivedData:"
          DERIVED_DATA=$(xcrun xcodebuild -showBuildSettings -project ALADDIN.xcodeproj -scheme ALADDIN 2>/dev/null | grep "BUILD_DIR" | head -1 | awk '{print $3}' || echo "")
          if [ -n "$DERIVED_DATA" ]; then
            echo "Build directory: $DERIVED_DATA"
            find "$DERIVED_DATA" -name "*.app" -type d 2>/dev/null | head -5 || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ $DERIVED_DATA"
          fi
          
          # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
          echo ""
          echo "üìÇ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–æ–∏—Å–∫–∞:"
          find /Users/runner/Library/Developer/Xcode/DerivedData -name "ALADDIN.app" -type d 2>/dev/null | head -3 || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DerivedData"
          
          echo ""
          echo "üéâ –†–ï–®–ï–ù–ò–ï –ù–ê–ô–î–ï–ù–û!"
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º: iPhone 16 Pro,OS=18.4 + DEPLOYMENT_TARGET=13.0"
          
        else
          echo "‚ùå –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥..."
          
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –¥—Ä—É–≥–∏–º–∏ runtime –≤–µ—Ä—Å–∏—è–º–∏
          for RUNTIME in "18.5" "18.6" "26.0"; do
            echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º iOS $RUNTIME..."
            if xcodebuild -project ALADDIN.xcodeproj -scheme ALADDIN \
              -destination "platform=iOS Simulator,name=iPhone 16 Pro,OS=$RUNTIME" \
              IPHONEOS_DEPLOYMENT_TARGET=13.0 \
              CODE_SIGNING_ALLOWED=NO \
              ASSETCATALOG_COMPILER_APPICON_NAME="" \
              build; then
              echo "‚úÖ –£–°–ü–ï–• —Å iOS $RUNTIME!"
              find . -name "*.app" -type d | head -5
              exit 0
            fi
          done
          
          echo "‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
          exit 1
        fi
        
        echo ""
        echo "üì± –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê .app –§–ê–ô–õ–ê:"
        find . -name "*.app" -type d | head -10 || echo "‚ùå .app —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    
    - name: Find and Upload .app file
      run: |
        cd mobile_apps/ALADDIN_iOS
        echo "üîç –ü–æ–∏—Å–∫ .app —Ñ–∞–π–ª–∞ –ø–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ..."
        
        # –ü–æ–∏—Å–∫ –≤–æ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
        APP_PATHS=()
        
        # 1. –õ–æ–∫–∞–ª—å–Ω–∞—è build –ø–∞–ø–∫–∞
        if [ -d "build" ]; then
          APP_PATHS+=("build"/*.app)
        fi
        
        # 2. DerivedData
        DERIVED_PATHS=$(find /Users/runner/Library/Developer/Xcode/DerivedData -name "ALADDIN.app" -type d 2>/dev/null || true)
        if [ -n "$DERIVED_PATHS" ]; then
          APP_PATHS+=($DERIVED_PATHS)
        fi
        
        # 3. –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º—É –ø—Ä–æ–µ–∫—Ç—É
        PROJECT_APPS=$(find . -name "*.app" -type d 2>/dev/null || true)
        if [ -n "$PROJECT_APPS" ]; then
          APP_PATHS+=($PROJECT_APPS)
        fi
        
        # 4. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ Xcode
        STANDARD_APPS=$(find /Users/runner/Library/Developer/Xcode/DerivedData -path "*Debug-iphonesimulator*" -name "*.app" -type d 2>/dev/null | head -5 || true)
        if [ -n "$STANDARD_APPS" ]; then
          APP_PATHS+=($STANDARD_APPS)
        fi
        
        echo "–ù–∞–π–¥–µ–Ω–æ –ø—É—Ç–µ–π: ${#APP_PATHS[@]}"
        for path in "${APP_PATHS[@]}"; do
          if [ -d "$path" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω .app: $path"
            ls -la "$path"
            echo "üì± –†–∞–∑–º–µ—Ä: $(du -sh "$path" 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")"
            echo "APP_PATH=$path" >> $GITHUB_ENV
            break
          fi
        done
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        if [ -z "$APP_PATH" ]; then
          echo "‚ùå .app —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
          echo "–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
          find . -name "build" -type d 2>/dev/null | head -5
          ls -la /Users/runner/Library/Developer/Xcode/DerivedData/ 2>/dev/null || echo "DerivedData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        fi
    
    - name: Upload .app file
      uses: actions/upload-artifact@v4
      if: env.APP_PATH != ''
      with:
        name: aladdin-ios-app-final
        path: ${{ env.APP_PATH }}
        if-no-files-found: warn
        retention-days: 30
    
    - name: Upload debug info
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build-debug-info
        path: mobile_apps/ALADDIN_iOS/
        if-no-files-found: warn
        retention-days: 7
