#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Universal Privacy Manager Part 2 - –ß–∞—Å—Ç—å 2 —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
"""

import json
import logging
import os
import time
from dataclasses import dataclass
from datetime import datetime
from enum import Enum
from typing import Any, Dict, List, Optional


class ConsentType(Enum):
    """–¢–∏–ø—ã —Å–æ–≥–ª–∞—Å–∏–π"""

    ANALYTICS = "analytics"
    MARKETING = "marketing"
    FUNCTIONAL = "functional"
    NECESSARY = "necessary"


@dataclass
class Consent:
    """–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö"""

    user_id: str
    consent_type: str
    granted: bool
    granted_at: datetime
    expires_at: Optional[datetime] = None

    def to_dict(self) -> Dict[str, Any]:
        return {
            "user_id": self.user_id,
            "consent_type": self.consent_type,
            "granted": self.granted,
            "granted_at": self.granted_at.isoformat(),
            "expires_at": (
                self.expires_at.isoformat() if self.expires_at else None
            ),
        }


@dataclass
class ConsentRecord:
    """–ó–∞–ø–∏—Å—å —Å–æ–≥–ª–∞—Å–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""

    consent_id: str
    user_id: str
    purpose: str
    consent_type: ConsentType
    legal_basis: str
    granted: bool
    granted_at: datetime
    expires_at: Optional[datetime] = None


class DataCategory(Enum):
    """–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö"""

    PERSONAL = "personal"
    SENSITIVE = "sensitive"
    ANALYTICS = "analytics"
    MARKETING = "marketing"


class PrivacyAction(Enum):
    """–î–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å—é"""

    CONSENT_GRANTED = "consent_granted"
    CONSENT_REVOKED = "consent_revoked"
    DATA_ACCESSED = "data_accessed"
    DATA_DELETED = "data_deleted"
    DATA_EXPORTED = "data_exported"


class PrivacyStandard(Enum):
    """–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏"""

    GDPR = "gdpr"
    CCPA = "ccpa"
    PIPEDA = "pipeda"
    LGPD = "lgpd"


@dataclass
class PrivacyEvent:
    """–°–æ–±—ã—Ç–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏"""

    user_id: str
    action: PrivacyAction
    timestamp: datetime
    details: Dict[str, Any]


class UniversalPrivacyManagerPart2:
    """–ß–∞—Å—Ç—å 2 —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏"""

    def __init__(self):
        self.logger = logging.getLogger("ALADDIN.UniversalPrivacyManagerPart2")
        self.consents = {}
        self.privacy_settings = {}
        self.data_retention_policies = {}
        self._init_default_policies()

    def _init_default_policies(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        self.data_retention_policies = {
            "personal_data": 365,  # 1 –≥–æ–¥
            "analytics_data": 90,  # 3 –º–µ—Å—è—Ü–∞
            "security_logs": 2555,  # 7 –ª–µ—Ç
            "cookies": 30,  # 1 –º–µ—Å—è—Ü
        }

    def _save_privacy_data(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏"""
        try:
            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–π
            consent_file = "data/privacy/consents.json"
            os.makedirs(os.path.dirname(consent_file), exist_ok=True)

            with open(consent_file, "w", encoding="utf-8") as f:
                consents_data = [
                    consent.to_dict() for consent in self.consents.values()
                ]
                json.dump(consents_data, f, ensure_ascii=False, indent=2)

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
            events_file = "data/privacy/privacy_events.json"
            with open(events_file, "w", encoding="utf-8") as f:
                events_data = [
                    event.to_dict() for event in self.privacy_events
                ]
                json.dump(events_data, f, ensure_ascii=False, indent=2)

            self.logger.info("–î–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏: {}".format(str(e))
            )

    def create_consent(
        self,
        user_id: str,
        purpose: str,
        consent_type: ConsentType,
        legal_basis: str = "",
        expires: datetime = None,
    ) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏—è"""
        try:
            consent_id = "consent_{}_{}".format(user_id, int(time.time()))

            consent = ConsentRecord(
                consent_id=consent_id,
                user_id=user_id,
                purpose=purpose,
                consent_type=consent_type,
                granted=True,
                expires=expires,
            )

            consent.legal_basis = legal_basis
            consent.withdrawal_method = "email,phone,web"

            self.consents[consent_id] = consent
            self._update_metrics()

            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
            self._log_privacy_event(
                user_id=user_id,
                action=PrivacyAction.COLLECT,
                data_category=DataCategory.PERSONAL,
                details={"consent_id": consent_id, "purpose": purpose},
            )

            self.logger.info(
                "–°–æ–∑–¥–∞–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ {} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {}".format(
                    consent_id, user_id
                )
            )
            return consent_id

        except Exception as e:
            self.logger.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏—è: {}".format(str(e)))
            return ""

    def revoke_consent(self, consent_id: str, user_id: str) -> bool:
        """–û—Ç–∑—ã–≤ —Å–æ–≥–ª–∞—Å–∏—è"""
        try:
            if consent_id not in self.consents:
                self.logger.warning(
                    "–°–æ–≥–ª–∞—Å–∏–µ {} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ".format(consent_id)
                )
                return False

            consent = self.consents[consent_id]
            if consent.user_id != user_id:
                self.logger.warning(
            self._update_metrics()

            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
            self._log_privacy_event(
                user_id=user_id,
                action=PrivacyAction.DELETE,
                data_category=DataCategory.PERSONAL,
                details={"consent_id": consent_id, "action": "revoked"},
            )

            self.logger.info(
                "–°–æ–≥–ª–∞—Å–∏–µ {} –æ—Ç–æ–∑–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {}".format(
                    consent_id, user_id
                )
            )
            return True

        except Exception as e:
            self.logger.error("–û—à–∏–±–∫–∞ –æ—Ç–∑—ã–≤–∞ —Å–æ–≥–ª–∞—Å–∏—è: {}".format(str(e)))
            return False

    def check_consent(self, user_id: str, purpose: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è"""
        try:
            for consent in self.consents.values():
                if (
                    consent.user_id == user_id
                    and consent.purpose == purpose
                    and consent.status == PrivacyStatus.ACTIVE
                    and consent.granted
                ):
                    return True

            return False

        except Exception as e:
            self.logger.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≥–ª–∞—Å–∏—è: {}".format(str(e)))
            return False

    def request_data_deletion(
        self, user_id: str, data_categories: List[DataCategory]
    ) -> str:
        """–ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö"""
        try:
            request_id = "deletion_{}_{}".format(user_id, int(time.time()))

            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
            self._log_privacy_event(
                user_id=user_id,
                action=PrivacyAction.DELETE,
                data_category=DataCategory.PERSONAL,
                details={
                    "request_id": request_id,
                    "categories": [cat.value for cat in data_categories],
                },
            )

            self.metrics.deletion_requests += 1
            self._update_metrics()

            self.logger.info(
                "–ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö {} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {}".format(
                    request_id, user_id
                )
            )
            return request_id

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: {}".format(str(e))
            )
            return ""

    def request_data_portability(
        self, user_id: str, data_categories: List[DataCategory]
    ) -> str:
        """–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö"""
        try:
            request_id = "portability_{}_{}".format(user_id, int(time.time()))

            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
            self._log_privacy_event(
                user_id=user_id,
                action=PrivacyAction.PORT,
                data_category=DataCategory.PERSONAL,
                details={
                    "request_id": request_id,
                    "categories": [cat.value for cat in data_categories],
                },
            )

            self.metrics.portability_requests += 1
            self._update_metrics()

            self.logger.info(
                "–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö {} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {}".format(
                    request_id, user_id
                )
            )
            return request_id

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: {}".format(str(e))
            )
            return ""

    def _log_privacy_event(
        self,
        user_id: str,
        action: PrivacyAction,
        data_category: DataCategory,
        details: dict = None,
    ):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏"""
        try:
            event_id = "event_{}_{}".format(user_id, int(time.time()))

            event = PrivacyEvent(
                event_id=event_id,
                user_id=user_id,
                action=action,
                data_category=data_category,
            )

            if details:
                event.details = details

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º
            for standard in self.privacy_standards:
                compliance = self._check_standard_compliance(event, standard)
                event.compliance_status[standard.value] = compliance

            self.privacy_events.append(event)
            self.metrics.privacy_events += 1

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏: {}".format(str(e))
            )

    def _check_standard_compliance(
        self, event: PrivacyEvent, standard: PrivacyStandard
    ) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É"""
        try:
            if standard == PrivacyStandard.GDPR:
                return self._check_gdpr_compliance(event)
            elif standard == PrivacyStandard.CCPA:
                return self._check_ccpa_compliance(event)
            elif standard == PrivacyStandard.FZ152:
                return self._check_fz152_compliance(event)
            else:
                return True

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É {}: {}".format(
                    standard.value, str(e)
                )
            )
            return False

    def _check_gdpr_compliance(self, event: PrivacyEvent) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è GDPR"""
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–æ–≥–ª–∞—Å–∏—è –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
            if event.action == PrivacyAction.COLLECT:
                return self.check_consent(event.user_id, "data_collection")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
            if event.action == PrivacyAction.DELETE:
                return True  # GDPR —Ç—Ä–µ–±—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∞ –Ω–∞ –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
            if event.action == PrivacyAction.PORT:
                return (
                    True  # GDPR —Ç—Ä–µ–±—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                )

            return True

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è GDPR: {}".format(str(e))
            )
            return False

    def _check_ccpa_compliance(self, event: PrivacyEvent) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è CCPA"""
        try:
            # CCPA —Ç—Ä–µ–±—É–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö
            if event.action == PrivacyAction.COLLECT:
                return True  # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

            # CCPA —Ç—Ä–µ–±—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
            if event.action == PrivacyAction.DELETE:
                return True

            return True

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è CCPA: {}".format(str(e))
            )
            return False

    def _check_fz152_compliance(self, event: PrivacyEvent) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è 152-–§–ó"""
        try:
            # 152-–§–ó —Ç—Ä–µ–±—É–µ—Ç —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if event.action in [PrivacyAction.COLLECT, PrivacyAction.PROCESS]:
                return self.check_consent(
                    event.user_id, "personal_data_processing"
                )

            return True

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è 152-–§–ó: {}".format(str(e))
            )
            return False

    def get_privacy_metrics(self) -> dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏"""
        try:
            metrics = self.metrics.to_dict()
            metrics["compliance_by_standard"] = {}

            for standard in self.privacy_standards:
                metrics["compliance_by_standard"][standard.value] = (
                    self._calculate_standard_compliance(standard)
                )

            return metrics

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏: {}".format(str(e))
            )
            return {}

    def get_user_consents(self, user_id: str) -> List[dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            user_consents = []
            for consent in self.consents.values():
                if consent.user_id == user_id:
                    user_consents.append(consent.to_dict())

            return user_consents

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {}".format(str(e))
            )
            return []

    def get_privacy_events(
        self, user_id: str = None, limit: int = 100
    ) -> List[dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏"""
        try:
            events = self.privacy_events

            if user_id:
                events = [e for e in events if e.user_id == user_id]

            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
            events.sort(key=lambda x: x.timestamp, reverse=True)

            # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            events = events[:limit]

            return [event.to_dict() for event in events]

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏: {}".format(str(e))
            )
            return []

    def anonymize_data(self, data: Any, data_category: DataCategory) -> Any:
        """–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö"""
        try:
            if data_category == DataCategory.PERSONAL:
                # –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if isinstance(data, str):
                    # –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫
                    return hashlib.sha256(data.encode()).hexdigest()[:8]
                elif isinstance(data, dict):
                    # –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è —Å–ª–æ–≤–∞—Ä—è
                    anonymized = {}
                    for key, value in data.items():
                        if key.lower() in [
                            "name",
                            "email",
                            "phone",
                            "address",
                        ]:
                            anonymized[key] = hashlib.sha256(
                                str(value).encode()
                            ).hexdigest()[:8]
                        else:
                            anonymized[key] = value
                    return anonymized

            elif data_category == DataCategory.LOCATION:
                # –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
                if isinstance(data, dict) and "lat" in data and "lng" in data:
                    return {
                        "lat": round(data["lat"], 1),  # –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 1 –∑–Ω–∞–∫–∞
                        "lng": round(data["lng"], 1),
                    }

            elif data_category == DataCategory.BEHAVIORAL:
                # –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
                if isinstance(data, list):
                    return [
                        hashlib.sha256(str(item).encode()).hexdigest()[:8]
                        for item in data
                    ]

            return data

        except Exception as e:
            self.logger.error("–û—à–∏–±–∫–∞ –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {}".format(str(e)))
            return data

    def generate_privacy_report(
        self, user_id: str = None, period_days: int = 30
    ) -> dict:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏"""
        try:
            end_date = datetime.now()
            start_date = end_date - timedelta(days=period_days)

            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –ø–æ –ø–µ—Ä–∏–æ–¥—É
            period_events = [
                e
                for e in self.privacy_events
                if start_date <= e.timestamp <= end_date
            ]

            if user_id:
                period_events = [
                    e for e in period_events if e.user_id == user_id
                ]

            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º
            action_stats = {}
            for event in period_events:
                action = event.action.value
                action_stats[action] = action_stats.get(action, 0) + 1

            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–∞–Ω–Ω—ã—Ö
            category_stats = {}
            for event in period_events:
                category = event.data_category.value
                category_stats[category] = category_stats.get(category, 0) + 1

            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
            compliance_stats = {}
            for standard in self.privacy_standards:
                compliant_events = sum(
                    1
                    for e in period_events
                    if e.compliance_status.get(standard.value, False)
                )
                total_events = len(period_events)
                compliance_stats[standard.value] = (
                    (compliant_events / total_events * 100)
                    if total_events > 0
                    else 0
                )

            report = {
                "period": {
                    "start": start_date.isoformat(),
                    "end": end_date.isoformat(),
                    "days": period_days,
                },
                "user_id": user_id,
                "total_events": len(period_events),
                "action_statistics": action_stats,
                "category_statistics": category_stats,
                "compliance_statistics": compliance_stats,
                "overall_compliance": (
                    sum(compliance_stats.values()) / len(compliance_stats)
                    if compliance_stats
                    else 0
                ),
                "generated_at": datetime.now().isoformat(),
            }

            return report

        except Exception as e:
            self.logger.error(
                "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ –æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏: {}".format(str(e))
            )
            return {}


if __name__ == "__main__":
    print("üîí UNIVERSAL PRIVACY MANAGER")
    print("=" * 50)

    # –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    manager = UniversalPrivacyManager("TestUniversalPrivacy")

    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    if manager.initialize():
        print("‚úÖ UniversalPrivacyManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏—è
        consent_id = manager.create_consent(
            user_id="user_001",
            purpose="data_collection",
            consent_type=ConsentType.EXPLICIT,
            legal_basis="consent",
        )
        print("‚úÖ –°–æ–∑–¥–∞–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ: {}".format(consent_id))

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è
        has_consent = manager.check_consent("user_001", "data_collection")
        print("‚úÖ –°–æ–≥–ª–∞—Å–∏–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ: {}".format(has_consent))

        # –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        deletion_id = manager.request_data_deletion(
            user_id="user_001", data_categories=[DataCategory.PERSONAL]
        )
        print("‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ: {}".format(deletion_id))

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        metrics = manager.get_privacy_metrics()
        print("‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã: {}".format(metrics))

        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
        manager.stop()
        print("‚úÖ UniversalPrivacyManager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    else:
        print("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ UniversalPrivacyManager")
            if consent.user_id != user_id:
                self.logger.warning(
                    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {} –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –æ—Ç–æ–∑–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ {}".format(
                        user_id, consent_id
                    )
                )
                return False
