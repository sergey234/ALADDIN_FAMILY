#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
SafeFunctionManager Integration - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è RateLimiter, CircuitBreaker –∏ UserInterfaceManager —Å SafeFunctionManager

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤—Å–µ—Ö —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —Å —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏, –≤–∫–ª—é—á–∞—è:
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ SafeFunctionManager
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Å–∏—Å—Ç–µ–º–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

–ê–≤—Ç–æ—Ä: ALADDIN Security System
–í–µ—Ä—Å–∏—è: 2.0
–î–∞—Ç–∞: 2025-01-27
–õ–∏—Ü–µ–Ω–∑–∏—è: MIT
"""

import asyncio
import logging
import time
import json
from datetime import datetime
from typing import Dict, List, Optional, Any, Union
import threading

# –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–º–ø–æ—Ä—Ç—ã
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from core.base import CoreBase
from core.service_base import ServiceBase
from core.security_base import SecurityBase
from core.database import Database
from core.configuration import Configuration

# –ò–º–ø–æ—Ä—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
from rate_limiter import RateLimiter, RateLimitRequest, RateLimitResponse
from circuit_breaker import CircuitBreaker, CircuitBreakerRequest, CircuitBreakerResponse
from user_interface_manager import UserInterfaceManager, InterfaceRequest, InterfaceResponse

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class SafeFunctionManagerIntegration(SecurityBase):
    """
    –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —Å SafeFunctionManager
    
    –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
    - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
    - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
    """
    
    def __init__(self, name: str = "SafeFunctionManagerIntegration", config: Optional[Dict[str, Any]] = None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        
        Args:
            name: –ò–º—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
            config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        """
        super().__init__(name, config)
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.default_config = {
            "enable_rate_limiter": True,
            "enable_circuit_breaker": True,
            "enable_user_interface_manager": True,
            "auto_start_services": True,
            "health_check_interval": 30,  # —Å–µ–∫—É–Ω–¥
            "integration_timeout": 60,  # —Å–µ–∫—É–Ω–¥
            "enable_monitoring": True,
            "enable_logging": True
        }
        
        # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
        self.config = {**self.default_config, **(config or {})}
        
        # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        self.rate_limiter: Optional[RateLimiter] = None
        self.circuit_breaker: Optional[CircuitBreaker] = None
        self.user_interface_manager: Optional[UserInterfaceManager] = None
        
        # –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.component_status = {
            "rate_limiter": {"status": "stopped", "last_check": None, "error": None},
            "circuit_breaker": {"status": "stopped", "last_check": None, "error": None},
            "user_interface_manager": {"status": "stopped", "last_check": None, "error": None}
        }
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats = {
            "total_requests": 0,
            "successful_requests": 0,
            "failed_requests": 0,
            "rate_limited_requests": 0,
            "circuit_breaker_blocks": 0,
            "interface_generations": 0,
            "integration_errors": 0
        }
        
        # –ü–æ—Ç–æ–∫–∏
        self.health_check_thread: Optional[threading.Thread] = None
        self.running = False
        
        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        self.lock = threading.RLock()
        
        self.logger.info(f"SafeFunctionManagerIntegration {name} –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    async def start(self) -> bool:
        """–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"""
        try:
            self.logger.info("–ó–∞–ø—É—Å–∫ SafeFunctionManagerIntegration")
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            await self._initialize_components()
            
            # –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            if self.config["auto_start_services"]:
                await self._start_components()
            
            # –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            if self.config["enable_monitoring"]:
                self.running = True
                self.health_check_thread = threading.Thread(target=self._health_check_worker, daemon=True)
                self.health_check_thread.start()
            
            self.logger.info("SafeFunctionManagerIntegration —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω")
            return True
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ SafeFunctionManagerIntegration: {e}")
            return False
    
    async def stop(self) -> bool:
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"""
        try:
            self.logger.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ SafeFunctionManagerIntegration")
            
            self.running = False
            
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            if self.health_check_thread and self.health_check_thread.is_alive():
                self.health_check_thread.join(timeout=5)
            
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            await self._stop_components()
            
            self.logger.info("SafeFunctionManagerIntegration —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            return True
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ SafeFunctionManagerIntegration: {e}")
            return False
    
    async def _initialize_components(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
        try:
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RateLimiter
            if self.config["enable_rate_limiter"]:
                self.rate_limiter = RateLimiter("IntegratedRateLimiter")
                self.logger.info("RateLimiter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CircuitBreaker
            if self.config["enable_circuit_breaker"]:
                self.circuit_breaker = CircuitBreaker("IntegratedCircuitBreaker")
                self.logger.info("CircuitBreaker –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UserInterfaceManager
            if self.config["enable_user_interface_manager"]:
                self.user_interface_manager = UserInterfaceManager("IntegratedUserInterfaceManager")
                self.logger.info("UserInterfaceManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: {e}")
            raise
    
    async def _start_components(self) -> None:
        """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
        try:
            # –ó–∞–ø—É—Å–∫ RateLimiter
            if self.rate_limiter:
                success = await self.rate_limiter.start()
                if success:
                    self.component_status["rate_limiter"]["status"] = "running"
                    self.logger.info("RateLimiter –∑–∞–ø—É—â–µ–Ω")
                else:
                    self.component_status["rate_limiter"]["status"] = "error"
                    self.component_status["rate_limiter"]["error"] = "Failed to start"
                    self.logger.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ RateLimiter")
            
            # –ó–∞–ø—É—Å–∫ CircuitBreaker
            if self.circuit_breaker:
                success = await self.circuit_breaker.start()
                if success:
                    self.component_status["circuit_breaker"]["status"] = "running"
                    self.logger.info("CircuitBreaker –∑–∞–ø—É—â–µ–Ω")
                else:
                    self.component_status["circuit_breaker"]["status"] = "error"
                    self.component_status["circuit_breaker"]["error"] = "Failed to start"
                    self.logger.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ CircuitBreaker")
            
            # –ó–∞–ø—É—Å–∫ UserInterfaceManager
            if self.user_interface_manager:
                success = await self.user_interface_manager.start()
                if success:
                    self.component_status["user_interface_manager"]["status"] = "running"
                    self.logger.info("UserInterfaceManager –∑–∞–ø—É—â–µ–Ω")
                else:
                    self.component_status["user_interface_manager"]["status"] = "error"
                    self.component_status["user_interface_manager"]["error"] = "Failed to start"
                    self.logger.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ UserInterfaceManager")
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: {e}")
            raise
    
    async def _stop_components(self) -> None:
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
        try:
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ RateLimiter
            if self.rate_limiter:
                success = await self.rate_limiter.stop()
                if success:
                    self.component_status["rate_limiter"]["status"] = "stopped"
                    self.logger.info("RateLimiter –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ CircuitBreaker
            if self.circuit_breaker:
                success = await self.circuit_breaker.stop()
                if success:
                    self.component_status["circuit_breaker"]["status"] = "stopped"
                    self.logger.info("CircuitBreaker –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ UserInterfaceManager
            if self.user_interface_manager:
                success = await self.user_interface_manager.stop()
                if success:
                    self.component_status["user_interface_manager"]["status"] = "stopped"
                    self.logger.info("UserInterfaceManager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: {e}")
    
    def _health_check_worker(self) -> None:
        """–§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
        while self.running:
            try:
                time.sleep(self.config["health_check_interval"])
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ RateLimiter
                if self.rate_limiter:
                    try:
                        status = await self.rate_limiter.get_status()
                        self.component_status["rate_limiter"]["status"] = status["status"]
                        self.component_status["rate_limiter"]["last_check"] = datetime.utcnow()
                        self.component_status["rate_limiter"]["error"] = None
                    except Exception as e:
                        self.component_status["rate_limiter"]["status"] = "error"
                        self.component_status["rate_limiter"]["error"] = str(e)
                        self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ RateLimiter: {e}")
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ CircuitBreaker
                if self.circuit_breaker:
                    try:
                        status = await self.circuit_breaker.get_status()
                        self.component_status["circuit_breaker"]["status"] = status["status"]
                        self.component_status["circuit_breaker"]["last_check"] = datetime.utcnow()
                        self.component_status["circuit_breaker"]["error"] = None
                    except Exception as e:
                        self.component_status["circuit_breaker"]["status"] = "error"
                        self.component_status["circuit_breaker"]["error"] = str(e)
                        self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ CircuitBreaker: {e}")
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ UserInterfaceManager
                if self.user_interface_manager:
                    try:
                        status = await self.user_interface_manager.get_status()
                        self.component_status["user_interface_manager"]["status"] = status["status"]
                        self.component_status["user_interface_manager"]["last_check"] = datetime.utcnow()
                        self.component_status["user_interface_manager"]["error"] = None
                    except Exception as e:
                        self.component_status["user_interface_manager"]["status"] = "error"
                        self.component_status["user_interface_manager"]["error"] = str(e)
                        self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ UserInterfaceManager: {e}")
                
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è: {e}")
    
    async def process_request(self, request: Dict[str, Any]) -> Dict[str, Any]:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        
        Args:
            request: –ó–∞–ø—Ä–æ—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            
        Returns:
            Dict[str, Any]: –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
        """
        start_time = time.time()
        
        try:
            with self.lock:
                self.stats["total_requests"] += 1
            
            # 1. Rate Limiting
            if self.rate_limiter and self.component_status["rate_limiter"]["status"] == "running":
                rate_limit_request = RateLimitRequest(
                    client_id=request.get("client_id", "unknown"),
                    client_type=request.get("client_type", "user"),
                    ip_address=request.get("ip_address"),
                    user_agent=request.get("user_agent"),
                    request_size=request.get("request_size", 1),
                    priority=request.get("priority", 1),
                    metadata=request.get("metadata", {})
                )
                
                rate_limit_response = await self.rate_limiter.check_rate_limit(rate_limit_request)
                
                if not rate_limit_response.allowed:
                    with self.lock:
                        self.stats["rate_limited_requests"] += 1
                    
                    return {
                        "success": False,
                        "error": "Rate limit exceeded",
                        "reason": rate_limit_response.reason,
                        "retry_after": rate_limit_response.retry_after,
                        "component": "rate_limiter"
                    }
            
            # 2. Circuit Breaker
            if self.circuit_breaker and self.component_status["circuit_breaker"]["status"] == "running":
                circuit_breaker_request = CircuitBreakerRequest(
                    service_name=request.get("service_name", "default"),
                    operation=request.get("operation", "process"),
                    operation_type=request.get("operation_type", "http"),
                    timeout=request.get("timeout"),
                    retry_count=request.get("retry_count", 0),
                    priority=request.get("priority", 1),
                    metadata=request.get("metadata", {})
                )
                
                # –ü—Ä–æ—Å—Ç–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                async def test_operation(**kwargs):
                    await asyncio.sleep(0.1)
                    return {"result": "success", "data": request.get("data", {})}
                
                circuit_breaker_response = await self.circuit_breaker.execute(circuit_breaker_request, test_operation)
                
                if not circuit_breaker_response.success:
                    with self.lock:
                        self.stats["circuit_breaker_blocks"] += 1
                    
                    return {
                        "success": False,
                        "error": "Circuit breaker blocked",
                        "reason": circuit_breaker_response.error,
                        "circuit_state": circuit_breaker_response.circuit_state,
                        "component": "circuit_breaker"
                    }
            
            # 3. User Interface Management
            if self.user_interface_manager and self.component_status["user_interface_manager"]["status"] == "running":
                interface_request = InterfaceRequest(
                    user_id=request.get("user_id", "unknown"),
                    interface_type=request.get("interface_type", "web"),
                    device_type=request.get("device_type", "desktop"),
                    platform=request.get("platform", "web"),
                    language=request.get("language"),
                    theme=request.get("theme"),
                    layout=request.get("layout"),
                    session_id=request.get("session_id"),
                    metadata=request.get("metadata", {})
                )
                
                interface_response = await self.user_interface_manager.get_interface(interface_request)
                
                if not interface_response.success:
                    return {
                        "success": False,
                        "error": "Interface generation failed",
                        "reason": interface_response.metadata.get("error"),
                        "component": "user_interface_manager"
                    }
                
                with self.lock:
                    self.stats["interface_generations"] += 1
                
                # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                request["interface_data"] = interface_response.interface_data
                request["user_preferences"] = interface_response.user_preferences
                request["recommendations"] = interface_response.recommendations
            
            # –£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
            with self.lock:
                self.stats["successful_requests"] += 1
            
            return {
                "success": True,
                "data": request,
                "processing_time": time.time() - start_time,
                "components_used": self._get_active_components()
            }
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: {e}")
            
            with self.lock:
                self.stats["failed_requests"] += 1
                self.stats["integration_errors"] += 1
            
            return {
                "success": False,
                "error": f"Integration error: {str(e)}",
                "processing_time": time.time() - start_time,
                "components_used": self._get_active_components()
            }
    
    def _get_active_components(self) -> List[str]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
        active_components = []
        
        if self.component_status["rate_limiter"]["status"] == "running":
            active_components.append("rate_limiter")
        
        if self.component_status["circuit_breaker"]["status"] == "running":
            active_components.append("circuit_breaker")
        
        if self.component_status["user_interface_manager"]["status"] == "running":
            active_components.append("user_interface_manager")
        
        return active_components
    
    async def get_integration_status(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"""
        with self.lock:
            return {
                "name": self.name,
                "status": "running" if self.running else "stopped",
                "stats": self.stats.copy(),
                "component_status": self.component_status.copy(),
                "active_components": self._get_active_components(),
                "config": {
                    "enable_rate_limiter": self.config["enable_rate_limiter"],
                    "enable_circuit_breaker": self.config["enable_circuit_breaker"],
                    "enable_user_interface_manager": self.config["enable_user_interface_manager"],
                    "auto_start_services": self.config["auto_start_services"]
                }
            }
    
    async def test_integration(self) -> Dict[str, Any]:
        """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
        test_results = {
            "rate_limiter": {"status": "not_tested", "error": None},
            "circuit_breaker": {"status": "not_tested", "error": None},
            "user_interface_manager": {"status": "not_tested", "error": None},
            "integration": {"status": "not_tested", "error": None}
        }
        
        try:
            # –¢–µ—Å—Ç RateLimiter
            if self.rate_limiter:
                try:
                    test_request = RateLimitRequest(
                        client_id="test_client",
                        client_type="user",
                        ip_address="127.0.0.1",
                        user_agent="TestAgent/1.0"
                    )
                    
                    response = await self.rate_limiter.check_rate_limit(test_request)
                    test_results["rate_limiter"]["status"] = "passed" if response.allowed else "limited"
                except Exception as e:
                    test_results["rate_limiter"]["status"] = "failed"
                    test_results["rate_limiter"]["error"] = str(e)
            
            # –¢–µ—Å—Ç CircuitBreaker
            if self.circuit_breaker:
                try:
                    test_request = CircuitBreakerRequest(
                        service_name="test_service",
                        operation="test_operation",
                        operation_type="http"
                    )
                    
                    async def test_operation(**kwargs):
                        return {"result": "success"}
                    
                    response = await self.circuit_breaker.execute(test_request, test_operation)
                    test_results["circuit_breaker"]["status"] = "passed" if response.success else "blocked"
                except Exception as e:
                    test_results["circuit_breaker"]["status"] = "failed"
                    test_results["circuit_breaker"]["error"] = str(e)
            
            # –¢–µ—Å—Ç UserInterfaceManager
            if self.user_interface_manager:
                try:
                    test_request = InterfaceRequest(
                        user_id="test_user",
                        interface_type="web",
                        device_type="desktop",
                        platform="web"
                    )
                    
                    response = await self.user_interface_manager.get_interface(test_request)
                    test_results["user_interface_manager"]["status"] = "passed" if response.success else "failed"
                except Exception as e:
                    test_results["user_interface_manager"]["status"] = "failed"
                    test_results["user_interface_manager"]["error"] = str(e)
            
            # –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
            try:
                test_request = {
                    "client_id": "test_client",
                    "client_type": "user",
                    "user_id": "test_user",
                    "interface_type": "web",
                    "device_type": "desktop",
                    "platform": "web",
                    "service_name": "test_service",
                    "operation": "test_operation",
                    "data": {"test": "data"}
                }
                
                response = await self.process_request(test_request)
                test_results["integration"]["status"] = "passed" if response["success"] else "failed"
            except Exception as e:
                test_results["integration"]["status"] = "failed"
                test_results["integration"]["error"] = str(e)
            
            return test_results
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: {e}")
            return test_results

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ SafeFunctionManager...")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    integration = SafeFunctionManagerIntegration("TestIntegration")
    
    try:
        # –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        success = await integration.start()
        if not success:
            print("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏")
            return
        
        print("‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞")
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        test_results = await integration.test_integration()
        
        print("\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
        for component, result in test_results.items():
            status = result["status"]
            error = result.get("error")
            if status == "passed":
                print(f"‚úÖ {component}: {status}")
            elif status == "failed":
                print(f"‚ùå {component}: {status} - {error}")
            else:
                print(f"‚ö†Ô∏è  {component}: {status}")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        status = await integration.get_integration_status()
        print(f"\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:")
        print(f"  - –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {status['stats']['total_requests']}")
        print(f"  - –£—Å–ø–µ—à–Ω—ã—Ö: {status['stats']['successful_requests']}")
        print(f"  - –ù–µ—É–¥–∞—á–Ω—ã—Ö: {status['stats']['failed_requests']}")
        print(f"  - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö rate limiter: {status['stats']['rate_limited_requests']}")
        print(f"  - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö circuit breaker: {status['stats']['circuit_breaker_blocks']}")
        print(f"  - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤: {status['stats']['interface_generations']}")
        
        print(f"\nüîß –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: {', '.join(status['active_components'])}")
        
        print("\nüéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
    
    finally:
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        await integration.stop()
        print("‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")

if __name__ == "__main__":
    asyncio.run(main())