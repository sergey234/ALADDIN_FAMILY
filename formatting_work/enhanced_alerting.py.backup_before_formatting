#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ALADDIN Security System - Enhanced Alerting System
–£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–ê–≤—Ç–æ—Ä: ALADDIN Security Team
–í–µ—Ä—Å–∏—è: 1.0
–î–∞—Ç–∞: 2025-09-08
"""

import smtplib
import json
import time
import threading
from datetime import datetime, timedelta
from typing import Dict, List, Any, Optional, Callable
from dataclasses import dataclass
from enum import Enum
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

from core.base import ComponentStatus, SecurityLevel
from core.security_base import SecurityBase


class AlertSeverity(Enum):
    """–£—Ä–æ–≤–Ω–∏ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –∞–ª–µ—Ä—Ç–æ–≤"""
    INFO = "info"
    WARNING = "warning"
    ERROR = "error"
    CRITICAL = "critical"


class AlertChannel(Enum):
    """–ö–∞–Ω–∞–ª—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤"""
    EMAIL = "email"
    SMS = "sms"
    WEBHOOK = "webhook"
    CONSOLE = "console"
    LOG = "log"


@dataclass
class AlertRule:
    """–ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–ª–µ—Ä—Ç–æ–≤"""
    rule_id: str
    name: str
    description: str
    condition: str
    severity: AlertSeverity
    channels: List[AlertChannel]
    enabled: bool = True
    cooldown: int = 300  # —Å–µ–∫—É–Ω–¥
    last_triggered: Optional[datetime] = None


@dataclass
class Alert:
    """–ê–ª–µ—Ä—Ç"""
    alert_id: str
    rule_id: str
    severity: AlertSeverity
    title: str
    message: str
    component: str
    timestamp: datetime
    metadata: Dict[str, Any]
    resolved: bool = False
    resolved_at: Optional[datetime] = None


class EnhancedAlertingSystem(SecurityBase):
    """–£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤"""
    
    def __init__(self):
        super().__init__("EnhancedAlertingSystem")
        self.service_name = "EnhancedAlertingSystem"
        self.status = ComponentStatus.RUNNING
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        self.config = self._load_config()
        
        # –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–ª–µ—Ä—Ç–æ–≤
        self.alerts: List[Alert] = []
        self.alert_rules: List[AlertRule] = []
        
        # –ö–∞–Ω–∞–ª—ã –æ—Ç–ø—Ä–∞–≤–∫–∏
        self.channels = self._initialize_channels()
        
        # –ü–æ—Ç–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        self.monitoring_thread = None
        self.running = False
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        self._initialize_default_rules()
        self._start_monitoring()
        
        self.logger.info("EnhancedAlertingSystem –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def _load_config(self) -> Dict[str, Any]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        return {
            'email': {
                'smtp_server': 'smtp.gmail.com',
                'smtp_port': 587,
                'username': '',
                'password': '',
                'from_email': 'aladdin@security.local',
                'to_emails': ['admin@security.local']
            },
            'sms': {
                'api_key': '',
                'api_url': 'https://api.sms.ru/sms/send',
                'phone_numbers': ['+79000000000']
            },
            'webhook': {
                'url': 'http://localhost:5000/api/webhook',
                'timeout': 10
            },
            'retention_days': 30,
            'max_alerts_per_hour': 100
        }
    
    def _initialize_channels(self) -> Dict[AlertChannel, Callable]:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–Ω–∞–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏"""
        return {
            AlertChannel.EMAIL: self._send_email_alert,
            AlertChannel.SMS: self._send_sms_alert,
            AlertChannel.WEBHOOK: self._send_webhook_alert,
            AlertChannel.CONSOLE: self._send_console_alert,
            AlertChannel.LOG: self._send_log_alert
        }
    
    def _initialize_default_rules(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        default_rules = [
            AlertRule(
                rule_id="high_cpu_usage",
                name="–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU",
                description="CPU –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 80%",
                condition="cpu_usage > 80",
                severity=AlertSeverity.WARNING,
                channels=[AlertChannel.EMAIL, AlertChannel.CONSOLE],
                cooldown=300
            ),
            AlertRule(
                rule_id="high_memory_usage",
                name="–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ø–∞–º—è—Ç—å",
                description="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 90%",
                condition="memory_usage > 90",
                severity=AlertSeverity.ERROR,
                channels=[AlertChannel.EMAIL, AlertChannel.SMS, AlertChannel.CONSOLE],
                cooldown=600
            ),
            AlertRule(
                rule_id="security_threat_detected",
                name="–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É–≥—Ä–æ–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
                description="–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é —É–≥—Ä–æ–∑—É",
                condition="threats_detected > 0",
                severity=AlertSeverity.CRITICAL,
                channels=[AlertChannel.EMAIL, AlertChannel.SMS, AlertChannel.WEBHOOK],
                cooldown=60
            ),
            AlertRule(
                rule_id="system_error",
                name="–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞",
                description="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞",
                condition="error_rate > 5",
                severity=AlertSeverity.CRITICAL,
                channels=[AlertChannel.EMAIL, AlertChannel.SMS, AlertChannel.CONSOLE],
                cooldown=120
            ),
            AlertRule(
                rule_id="low_disk_space",
                name="–ú–∞–ª–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ",
                description="–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ –º–µ–Ω–µ–µ 10%",
                condition="disk_free_percent < 10",
                severity=AlertSeverity.WARNING,
                channels=[AlertChannel.EMAIL, AlertChannel.CONSOLE],
                cooldown=1800
            )
        ]
        
        self.alert_rules.extend(default_rules)
        self.logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(default_rules)} –ø—Ä–∞–≤–∏–ª –∞–ª–µ—Ä—Ç–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
    
    def add_alert_rule(self, rule: AlertRule):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–∞"""
        self.alert_rules.append(rule)
        self.logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –∞–ª–µ—Ä—Ç–∞: {rule.name}")
    
    def remove_alert_rule(self, rule_id: str):
        """–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–∞"""
        self.alert_rules = [rule for rule in self.alert_rules if rule.rule_id != rule_id]
        self.logger.info(f"–£–¥–∞–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –∞–ª–µ—Ä—Ç–∞: {rule_id}")
    
    def _start_monitoring(self):
        """–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""
        self.running = True
        self.monitoring_thread = threading.Thread(target=self._monitoring_loop, daemon=True)
        self.monitoring_thread.start()
        self.logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–ª–µ—Ä—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω")
    
    def _monitoring_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""
        while self.running:
            try:
                # –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ —Å–∏—Å—Ç–µ–º—ã
                metrics = self._collect_system_metrics()
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª
                for rule in self.alert_rules:
                    if not rule.enabled:
                        continue
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ cooldown
                    if rule.last_triggered:
                        time_since_last = (datetime.now() - rule.last_triggered).total_seconds()
                        if time_since_last < rule.cooldown:
                            continue
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏—è
                    if self._evaluate_condition(rule.condition, metrics):
                        self._trigger_alert(rule, metrics)
                        rule.last_triggered = datetime.now()
                
                # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤
                self._cleanup_old_alerts()
                
                time.sleep(10)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {e}")
                time.sleep(30)
    
    def _collect_system_metrics(self) -> Dict[str, Any]:
        """–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ —Å–∏—Å—Ç–µ–º—ã"""
        try:
            import psutil
            
            return {
                'cpu_usage': psutil.cpu_percent(interval=1),
                'memory_usage': psutil.virtual_memory().percent,
                'disk_free_percent': psutil.disk_usage('/').free / psutil.disk_usage('/').total * 100,
                'threats_detected': 0,  # –ó–∞–≥–ª—É—à–∫–∞
                'error_rate': 0,  # –ó–∞–≥–ª—É—à–∫–∞
                'timestamp': datetime.now().isoformat()
            }
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫: {e}")
            return {}
    
    def _evaluate_condition(self, condition: str, metrics: Dict[str, Any]) -> bool:
        """–û—Ü–µ–Ω–∫–∞ —É—Å–ª–æ–≤–∏—è –∞–ª–µ—Ä—Ç–∞"""
        try:
            # –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π
            if 'cpu_usage >' in condition:
                threshold = float(condition.split('>')[1].strip())
                return metrics.get('cpu_usage', 0) > threshold
            elif 'memory_usage >' in condition:
                threshold = float(condition.split('>')[1].strip())
                return metrics.get('memory_usage', 0) > threshold
            elif 'disk_free_percent <' in condition:
                threshold = float(condition.split('<')[1].strip())
                return metrics.get('disk_free_percent', 100) < threshold
            elif 'threats_detected >' in condition:
                threshold = int(condition.split('>')[1].strip())
                return metrics.get('threats_detected', 0) > threshold
            elif 'error_rate >' in condition:
                threshold = float(condition.split('>')[1].strip())
                return metrics.get('error_rate', 0) > threshold
            
            return False
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ —É—Å–ª–æ–≤–∏—è '{condition}': {e}")
            return False
    
    def _trigger_alert(self, rule: AlertRule, metrics: Dict[str, Any]):
        """–°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞"""
        alert_id = f"alert_{int(time.time())}_{rule.rule_id}"
        
        alert = Alert(
            alert_id=alert_id,
            rule_id=rule.rule_id,
            severity=rule.severity,
            title=rule.name,
            message=rule.description,
            component="SystemMonitor",
            timestamp=datetime.now(),
            metadata=metrics
        )
        
        self.alerts.append(alert)
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª—ã
        for channel in rule.channels:
            try:
                self.channels[channel](alert)
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–∞ —á–µ—Ä–µ–∑ {channel.value}: {e}")
        
        self.logger.warning(f"–°—Ä–∞–±–æ—Ç–∞–ª –∞–ª–µ—Ä—Ç: {rule.name} (ID: {alert_id})")
    
    def _send_email_alert(self, alert: Alert):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –ø–æ email"""
        try:
            config = self.config['email']
            if not config['username'] or not config['password']:
                self.logger.warning("Email –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É")
                return
            
            msg = MIMEMultipart()
            msg['From'] = config['from_email']
            msg['To'] = ', '.join(config['to_emails'])
            msg['Subject'] = f"[{alert.severity.value.upper()}] {alert.title}"
            
            body = f"""
            –ê–ª–µ—Ä—Ç —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ALADDIN
            
            –£—Ä–æ–≤–µ–Ω—å: {alert.severity.value.upper()}
            –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: {alert.component}
            –í—Ä–µ–º—è: {alert.timestamp.strftime('%Y-%m-%d %H:%M:%S')}
            
            –°–æ–æ–±—â–µ–Ω–∏–µ: {alert.message}
            
            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
            {json.dumps(alert.metadata, indent=2, ensure_ascii=False)}
            """
            
            msg.attach(MIMEText(body, 'plain', 'utf-8'))
            
            server = smtplib.SMTP(config['smtp_server'], config['smtp_port'])
            server.starttls()
            server.login(config['username'], config['password'])
            server.send_message(msg)
            server.quit()
            
            self.logger.info(f"–ê–ª–µ—Ä—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ email: {alert.alert_id}")
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email: {e}")
    
    def _send_sms_alert(self, alert: Alert):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –ø–æ SMS"""
        try:
            config = self.config['sms']
            if not config['api_key']:
                self.logger.warning("SMS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É")
                return
            
            message = f"[{alert.severity.value.upper()}] {alert.title}: {alert.message}"
            
            # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SMS API
            self.logger.info(f"SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {alert.alert_id}")
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS: {e}")
    
    def _send_webhook_alert(self, alert: Alert):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ —á–µ—Ä–µ–∑ webhook"""
        try:
            import requests
            
            config = self.config['webhook']
            url = config['url']
            
            payload = {
                'alert_id': alert.alert_id,
                'severity': alert.severity.value,
                'title': alert.title,
                'message': alert.message,
                'component': alert.component,
                'timestamp': alert.timestamp.isoformat(),
                'metadata': alert.metadata
            }
            
            response = requests.post(url, json=payload, timeout=config['timeout'])
            response.raise_for_status()
            
            self.logger.info(f"Webhook –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {alert.alert_id}")
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ webhook: {e}")
    
    def _send_console_alert(self, alert: Alert):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª—å"""
        severity_colors = {
            AlertSeverity.INFO: '\033[94m',      # –°–∏–Ω–∏–π
            AlertSeverity.WARNING: '\033[93m',   # –ñ–µ–ª—Ç—ã–π
            AlertSeverity.ERROR: '\033[91m',     # –ö—Ä–∞—Å–Ω—ã–π
            AlertSeverity.CRITICAL: '\033[95m'   # –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
        }
        
        color = severity_colors.get(alert.severity, '')
        reset = '\033[0m'
        
        print(f"{color}[{alert.severity.value.upper()}] {alert.title}{reset}")
        print(f"  –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: {alert.component}")
        print(f"  –í—Ä–µ–º—è: {alert.timestamp.strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"  –°–æ–æ–±—â–µ–Ω–∏–µ: {alert.message}")
        print()
    
    def _send_log_alert(self, alert: Alert):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –≤ –ª–æ–≥"""
        self.logger.warning(f"ALERT [{alert.severity.value.upper()}] {alert.title}: {alert.message}")
    
    def _cleanup_old_alerts(self):
        """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤"""
        cutoff_date = datetime.now() - timedelta(days=self.config['retention_days'])
        old_count = len(self.alerts)
        
        self.alerts = [alert for alert in self.alerts if alert.timestamp > cutoff_date]
        
        removed_count = old_count - len(self.alerts)
        if removed_count > 0:
            self.logger.info(f"–£–¥–∞–ª–µ–Ω–æ {removed_count} —Å—Ç–∞—Ä—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤")
    
    def get_alerts(self, limit: int = 50, severity: Optional[AlertSeverity] = None) -> List[Alert]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤"""
        alerts = self.alerts
        
        if severity:
            alerts = [alert for alert in alerts if alert.severity == severity]
        
        return sorted(alerts, key=lambda x: x.timestamp, reverse=True)[:limit]
    
    def resolve_alert(self, alert_id: str):
        """–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞"""
        for alert in self.alerts:
            if alert.alert_id == alert_id:
                alert.resolved = True
                alert.resolved_at = datetime.now()
                self.logger.info(f"–ê–ª–µ—Ä—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω: {alert_id}")
                break
    
    def get_alert_statistics(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤"""
        total_alerts = len(self.alerts)
        unresolved_alerts = len([a for a in self.alerts if not a.resolved])
        
        severity_counts = {}
        for severity in AlertSeverity:
            severity_counts[severity.value] = len([a for a in self.alerts if a.severity == severity])
        
        return {
            'total_alerts': total_alerts,
            'unresolved_alerts': unresolved_alerts,
            'severity_counts': severity_counts,
            'active_rules': len([r for r in self.alert_rules if r.enabled]),
            'last_alert': self.alerts[-1].timestamp.isoformat() if self.alerts else None
        }
    
    def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∞–ª–µ—Ä—Ç–æ–≤"""
        self.running = False
        if self.monitoring_thread:
            self.monitoring_thread.join(timeout=5)
        self.logger.info("–°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")


# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞–ª–µ—Ä—Ç–æ–≤
    alerting_system = EnhancedAlertingSystem()
    
    try:
        # –†–∞–±–æ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã
        print("üö® –°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
        
        while True:
            time.sleep(1)
            
            # –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            if int(time.time()) % 30 == 0:
                stats = alerting_system.get_alert_statistics()
                print(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤: {stats['total_alerts']} –≤—Å–µ–≥–æ, {stats['unresolved_alerts']} –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö")
    
    except KeyboardInterrupt:
        print("\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∞–ª–µ—Ä—Ç–æ–≤...")
        alerting_system.stop()
        print("‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")