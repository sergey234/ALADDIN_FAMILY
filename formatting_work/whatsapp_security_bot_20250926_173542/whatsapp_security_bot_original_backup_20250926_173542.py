#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
WhatsAppSecurityBot - –ë–æ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ WhatsApp
function_91: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –±–æ—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ WhatsApp

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ WhatsApp,
–≤–∫–ª—é—á–∞—é—â–µ–≥–æ:
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
- –î–µ—Ç–µ–∫—Ü–∏—è —Å–ø–∞–º–∞ –∏ —Ñ–∏—à–∏–Ω–≥–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
- –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
- –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Ç–æ–≤
- –ê–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
- –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
1. –£–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
2. –î–µ—Ç–µ–∫—Ü–∏—è —Å–ø–∞–º–∞ –∏ —Ñ–∏—à–∏–Ω–≥–∞
3. –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
4. –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
5. –ê–Ω–∞–ª–∏–∑ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
6. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
7. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
8. –ê–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
9. –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å
10. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ML –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç NLP –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç —Å WhatsApp Business API
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—ã–µ –¥–≤–∏–∂–∫–∏
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö —É–≥—Ä–æ–∑
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏

–ê–≤—Ç–æ—Ä: ALADDIN Security System
–í–µ—Ä—Å–∏—è: 2.0
–î–∞—Ç–∞: 2025-01-27
–õ–∏—Ü–µ–Ω–∑–∏—è: MIT
"""

from core.base import ComponentStatus, SecurityBase, SecurityLevel
import asyncio
import hashlib
import json
import logging
import time
from datetime import datetime, timedelta
from enum import Enum
from typing import Dict, List, Optional, Any, Tuple
from dataclasses import dataclass, field
import threading
from collections import defaultdict

# –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
import redis
import sqlalchemy
from sqlalchemy import create_engine, Column, String, Integer, DateTime, Boolean, JSON, Text, Float
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from pydantic import BaseModel, Field, validator
from prometheus_client import Counter, Histogram, Gauge
import numpy as np
from sklearn.ensemble import IsolationForest
from sklearn.preprocessing import StandardScaler

# –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–º–ø–æ—Ä—Ç—ã
import sys
import os
sys.path.append(
    os.path.dirname(
        os.path.dirname(
            os.path.dirname(
                os.path.abspath(__file__)))))


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
Base = declarative_base()


class MessageType(Enum):
    """–¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π WhatsApp"""
    TEXT = "text"
    IMAGE = "image"
    VIDEO = "video"
    AUDIO = "audio"
    DOCUMENT = "document"
    LOCATION = "location"
    CONTACT = "contact"
    STICKER = "sticker"
    VOICE_MESSAGE = "voice_message"
    SYSTEM = "system"


class ThreatLevel(Enum):
    """–£—Ä–æ–≤–Ω–∏ —É–≥—Ä–æ–∑"""
    SAFE = "safe"
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"


class MessageStatus(Enum):
    """–°—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π"""
    SENT = "sent"
    DELIVERED = "delivered"
    READ = "read"
    BLOCKED = "blocked"
    QUARANTINED = "quarantined"
    DELETED = "deleted"


class WhatsAppMessage(Base):
    """–°–æ–æ–±—â–µ–Ω–∏–µ WhatsApp"""
    __tablename__ = "whatsapp_messages"

    id = Column(String, primary_key=True)
    message_id = Column(String, nullable=False)
    chat_id = Column(String, nullable=False)
    sender_id = Column(String, nullable=False)
    receiver_id = Column(String, nullable=False)
    message_type = Column(String, nullable=False)
    content = Column(Text)
    media_url = Column(String)
    timestamp = Column(DateTime, default=datetime.utcnow)
    threat_level = Column(String, default=ThreatLevel.SAFE.value)
    is_encrypted = Column(Boolean, default=True)
    is_blocked = Column(Boolean, default=False)
    analysis_result = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)


class WhatsAppContact(Base):
    """–ö–æ–Ω—Ç–∞–∫—Ç WhatsApp"""
    __tablename__ = "whatsapp_contacts"

    id = Column(String, primary_key=True)
    phone_number = Column(String, nullable=False)
    name = Column(String)
    is_blocked = Column(Boolean, default=False)
    is_verified = Column(Boolean, default=False)
    threat_score = Column(Float, default=0.0)
    last_interaction = Column(DateTime)
    interaction_count = Column(Integer, default=0)
    created_at = Column(DateTime, default=datetime.utcnow)


class SecurityRule(Base):
    """–ü—Ä–∞–≤–∏–ª–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    __tablename__ = "security_rules"

    id = Column(String, primary_key=True)
    rule_name = Column(String, nullable=False)
    rule_type = Column(String, nullable=False)
    pattern = Column(String, nullable=False)
    action = Column(String, nullable=False)
    is_active = Column(Boolean, default=True)
    priority = Column(Integer, default=1)
    created_at = Column(DateTime, default=datetime.utcnow)


class MessageAnalysisResult(BaseModel):
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    message_id: str
    threat_level: ThreatLevel
    is_spam: bool = False
    is_phishing: bool = False
    is_malicious: bool = False
    confidence: float = 0.0
    detected_patterns: List[str] = Field(default_factory=list)
    recommended_action: str = "allow"
    risk_factors: List[str] = Field(default_factory=list)
    analysis_timestamp: datetime = Field(default_factory=datetime.utcnow)


class WhatsAppSecurityConfig(BaseModel):
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ WhatsApp"""
    spam_detection: bool = True
    phishing_protection: bool = True
    malware_scanning: bool = True
    link_analysis: bool = True
    contact_verification: bool = True
    encryption_enabled: bool = True
    backup_enabled: bool = True
    parental_control: bool = False
    auto_block_suspicious: bool = False
    notification_alerts: bool = True


# Prometheus –º–µ—Ç—Ä–∏–∫–∏
messages_analyzed_total = Counter(
    'whatsapp_messages_analyzed_total',
    'Total number of WhatsApp messages analyzed',
    ['threat_level', 'message_type']
)

threats_detected_total = Counter(
    'whatsapp_threats_detected_total',
    'Total number of threats detected in WhatsApp',
    ['threat_type', 'severity']
)

messages_blocked_total = Counter(
    'whatsapp_messages_blocked_total',
    'Total number of WhatsApp messages blocked',
    ['reason', 'threat_level']
)

active_chats = Gauge(
    'whatsapp_active_chats',
    'Number of active WhatsApp chats'
)


class WhatsAppSecurityBot(SecurityBase):
    """
    –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –±–æ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ WhatsApp

    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ WhatsApp —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
    - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    - –î–µ—Ç–µ–∫—Ü–∏–∏ —Å–ø–∞–º–∞ –∏ —Ñ–∏—à–∏–Ω–≥–∞
    - –ó–∞—â–∏—Ç—ã –æ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
    - –ö–æ–Ω—Ç—Ä–æ–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
    - –ê–Ω–∞–ª–∏–∑–∞ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    """

    def __init__(self, name: str = "WhatsAppSecurityBot",
                 config: Optional[Dict[str, Any]] = None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WhatsAppSecurityBot

        Args:
            name: –ò–º—è –±–æ—Ç–∞
            config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        """
        super().__init__(name, config)

        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.default_config = {
            "redis_url": "redis://localhost:6379/0",
            "database_url": "sqlite:///whatsapp_security_bot.db",
            "spam_detection": True,
            "phishing_protection": True,
            "malware_scanning": True,
            "link_analysis": True,
            "contact_verification": True,
            "encryption_enabled": True,
            "backup_enabled": True,
            "parental_control": False,
            "auto_block_suspicious": False,
            "notification_alerts": True,
            "ml_enabled": True,
            "adaptive_learning": True,
            "real_time_monitoring": True,
            "cleanup_interval": 300,
            "metrics_enabled": True,
            "logging_enabled": True
        }

        # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
        self.config = {**self.default_config, **(config or {})}

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.redis_client: Optional[redis.Redis] = None
        self.db_engine: Optional[sqlalchemy.Engine] = None
        self.db_session: Optional[sqlalchemy.orm.Session] = None
        self.security_rules: Dict[str, SecurityRule] = {}
        self.blocked_contacts: Dict[str, WhatsAppContact] = {}
        self.ml_model: Optional[IsolationForest] = None
        self.scaler: Optional[StandardScaler] = None

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats = {
            "total_messages": 0,
            "analyzed_messages": 0,
            "blocked_messages": 0,
            "threats_detected": 0,
            "spam_detected": 0,
            "phishing_detected": 0,
            "malware_detected": 0,
            "active_chats": 0,
            "blocked_contacts": 0,
            "false_positives": 0
        }

        # –ü–æ—Ç–æ–∫–∏
        self.monitoring_thread: Optional[threading.Thread] = None
        self.running = False

        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        self.lock = threading.RLock()

        self.logger.info(f"WhatsAppSecurityBot {name} –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

    async def start(self) -> bool:
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ WhatsApp"""
        try:
            with self.lock:
                if self.running:
                    self.logger.warning("WhatsAppSecurityBot —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
                    return True

                # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                await self._setup_database()

                # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis
                await self._setup_redis()

                # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ML –º–æ–¥–µ–ª–∏
                if self.config.get("ml_enabled", True):
                    await self._setup_ml_model()

                # –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                await self._load_security_rules()

                # –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                self.running = True
                self.monitoring_thread = threading.Thread(
                    target=self._monitoring_worker)
                self.monitoring_thread.daemon = True
                self.monitoring_thread.start()

                self.logger.info("WhatsAppSecurityBot –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ")
                return True

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ WhatsAppSecurityBot: {e}")
            return False

    async def stop(self) -> bool:
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ WhatsApp"""
        try:
            with self.lock:
                if not self.running:
                    self.logger.warning("WhatsAppSecurityBot —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                    return True

                self.running = False

                # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤
                if self.monitoring_thread and self.monitoring_thread.is_alive():
                    self.monitoring_thread.join(timeout=5)

                # –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                if self.db_session:
                    self.db_session.close()

                if self.redis_client:
                    self.redis_client.close()

                self.logger.info("WhatsAppSecurityBot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                return True

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ WhatsAppSecurityBot: {e}")
            return False

    async def _setup_database(self) -> None:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            database_url = self.config.get(
                "database_url", "sqlite:///whatsapp_security_bot.db")
            self.db_engine = create_engine(database_url)
            Base.metadata.create_all(self.db_engine)

            Session = sessionmaker(bind=self.db_engine)
            self.db_session = Session()

            self.logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö WhatsAppSecurityBot –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
            raise

    async def _setup_redis(self) -> None:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis"""
        try:
            redis_url = self.config.get(
                "redis_url", "redis://localhost:6379/0")
            self.redis_client = redis.from_url(
                redis_url, decode_responses=True)

            # –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            self.redis_client.ping()

            self.logger.info("Redis –¥–ª—è WhatsAppSecurityBot –Ω–∞—Å—Ç—Ä–æ–µ–Ω")

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Redis: {e}")
            raise

    async def _setup_ml_model(self) -> None:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ML –º–æ–¥–µ–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            self.ml_model = IsolationForest(
                contamination=0.1,
                random_state=42,
                n_estimators=100
            )
            self.scaler = StandardScaler()

            self.logger.info("ML –º–æ–¥–µ–ª—å WhatsAppSecurityBot –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ML –º–æ–¥–µ–ª–∏: {e}")

    async def _load_security_rules(self) -> None:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        try:
            if self.db_session:
                rules = self.db_session.query(SecurityRule).filter(
                    SecurityRule.is_active
                ).all()

                for rule in rules:
                    self.security_rules[rule.id] = rule

                self.logger.info(
                    f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.security_rules)} –ø—Ä–∞–≤–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}")

    def _monitoring_worker(self) -> None:
        """–§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""
        while self.running:
            try:
                time.sleep(1)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                self._update_stats()

                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
                self._process_message_queue()

            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {e}")

    def _update_stats(self) -> None:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        try:
            with self.lock:
                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ Prometheus
                active_chats.set(self.stats["active_chats"])

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

    def _process_message_queue(self) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            # –ü–æ–∫–∞ —á—Ç–æ –∑–∞–≥–ª—É—à–∫–∞
            pass

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")

    async def analyze_message(
            self, message_data: Dict[str, Any]) -> MessageAnalysisResult:
        """–ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è WhatsApp –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —É–≥—Ä–æ–∑"""
        try:
            message_id = message_data.get("id", "")
            content = message_data.get("content", "")
            message_type = MessageType(message_data.get("type", "text"))
            # sender_id = message_data.get("sender_id", "")

            # –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
            threat_level = ThreatLevel.SAFE
            is_spam = False
            is_phishing = False
            is_malicious = False
            confidence = 0.0
            detected_patterns = []
            risk_factors = []

            # –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if message_type == MessageType.TEXT and content:
                analysis_result = await self._analyze_text_content(content)
                threat_level = analysis_result["threat_level"]
                is_spam = analysis_result["is_spam"]
                is_phishing = analysis_result["is_phishing"]
                is_malicious = analysis_result["is_malicious"]
                confidence = analysis_result["confidence"]
                detected_patterns = analysis_result["detected_patterns"]
                risk_factors = analysis_result["risk_factors"]

            # –ê–Ω–∞–ª–∏–∑ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
            elif message_type in [MessageType.IMAGE, MessageType.VIDEO, MessageType.DOCUMENT]:
                analysis_result = await self._analyze_media_content(message_data)
                threat_level = analysis_result["threat_level"]
                is_malicious = analysis_result["is_malicious"]
                confidence = analysis_result["confidence"]
                detected_patterns = analysis_result["detected_patterns"]
                risk_factors = analysis_result["risk_factors"]

            # –ê–Ω–∞–ª–∏–∑ —Å—Å—ã–ª–æ–∫
            if content and ("http" in content or "www." in content):
                link_analysis = await self._analyze_links(content)
                if link_analysis["is_malicious"]:
                    threat_level = max(
                        threat_level,
                        ThreatLevel.HIGH,
                        key=lambda x: x.value)
                    is_malicious = True
                    detected_patterns.extend(
                        link_analysis["detected_patterns"])
                    risk_factors.extend(link_analysis["risk_factors"])

            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
            recommended_action = self._get_recommended_action(
                threat_level, is_spam, is_phishing, is_malicious)

            # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
            result = MessageAnalysisResult(
                message_id=message_id,
                threat_level=threat_level,
                is_spam=is_spam,
                is_phishing=is_phishing,
                is_malicious=is_malicious,
                confidence=confidence,
                detected_patterns=detected_patterns,
                recommended_action=recommended_action,
                risk_factors=risk_factors
            )

            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            self.stats["total_messages"] += 1
            self.stats["analyzed_messages"] += 1

            if threat_level != ThreatLevel.SAFE:
                self.stats["threats_detected"] += 1

            if is_spam:
                self.stats["spam_detected"] += 1

            if is_phishing:
                self.stats["phishing_detected"] += 1

            if is_malicious:
                self.stats["malware_detected"] += 1

            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
            messages_analyzed_total.labels(
                threat_level=threat_level.value,
                message_type=message_type.value
            ).inc()

            if threat_level != ThreatLevel.SAFE:
                threats_detected_total.labels(
                    threat_type="general",
                    severity=threat_level.value
                ).inc()

            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            await self._log_message_analysis(message_data, result)

            return result

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return MessageAnalysisResult(
                message_id=message_data.get("id", ""),
                threat_level=ThreatLevel.SAFE,
                recommended_action="allow"
            )

    async def _analyze_text_content(self, content: str) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        try:
            threat_level = ThreatLevel.SAFE
            is_spam = False
            is_phishing = False
            is_malicious = False
            confidence = 0.0
            detected_patterns = []
            risk_factors = []

            content_lower = content.lower()

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º
            spam_indicators = [
                "–±–µ—Å–ø–ª–∞—Ç–Ω–æ", "—Å—Ä–æ—á–Ω–æ", "—Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è", "–Ω–µ —É–ø—É—Å—Ç–∏—Ç–µ",
                "–≥–∞—Ä–∞–Ω—Ç–∏—è", "100%", "–±–µ–∑ —Ä–∏—Å–∫–∞", "–±—ã—Å—Ç—Ä–æ", "–ª–µ–≥–∫–æ"
            ]

            spam_count = sum(
                1 for indicator in spam_indicators if indicator in content_lower)
            if spam_count >= 3:
                is_spam = True
                threat_level = ThreatLevel.MEDIUM
                confidence = min(0.9, spam_count * 0.2)
                detected_patterns.append("spam_indicators")
                risk_factors.append("multiple_spam_keywords")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–∏—à–∏–Ω–≥
            phishing_indicators = [
                "–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ", "–æ–±–Ω–æ–≤–∏—Ç–µ", "–ø—Ä–æ–≤–µ—Ä—å—Ç–µ", "–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ",
                "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω", "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω", "–∏—Å—Ç–µ–∫–∞–µ—Ç", "—Å—Ä–æ—á–Ω–æ"
            ]

            phishing_count = sum(
                1 for indicator in phishing_indicators if indicator in content_lower)
            if phishing_count >= 2:
                is_phishing = True
                threat_level = ThreatLevel.HIGH
                confidence = min(0.95, phishing_count * 0.3)
                detected_patterns.append("phishing_indicators")
                risk_factors.append("phishing_keywords")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
            if "http" in content or "www." in content:
                detected_patterns.append("contains_links")
                risk_factors.append("suspicious_links")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
            suspicious_chars = ["$", "‚Ç¨", "‚ÇΩ", "bitcoin", "btc", "crypto"]
            if any(char in content_lower for char in suspicious_chars):
                detected_patterns.append("suspicious_characters")
                risk_factors.append("financial_keywords")

            return {
                "threat_level": threat_level,
                "is_spam": is_spam,
                "is_phishing": is_phishing,
                "is_malicious": is_malicious,
                "confidence": confidence,
                "detected_patterns": detected_patterns,
                "risk_factors": risk_factors
            }

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {e}")
            return {
                "threat_level": ThreatLevel.SAFE,
                "is_spam": False,
                "is_phishing": False,
                "is_malicious": False,
                "confidence": 0.0,
                "detected_patterns": [],
                "risk_factors": []
            }

    async def _analyze_media_content(
            self, message_data: Dict[str, Any]) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤"""
        try:
            # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—ã–º–∏ –¥–≤–∏–∂–∫–∞–º–∏
            # –ü–æ–∫–∞ —á—Ç–æ –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

            threat_level = ThreatLevel.SAFE
            is_malicious = False
            confidence = 0.0
            detected_patterns = []
            risk_factors = []

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
            file_size = message_data.get("file_size", 0)
            if file_size > 100 * 1024 * 1024:  # 100MB
                detected_patterns.append("large_file")
                risk_factors.append("suspicious_file_size")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            file_name = message_data.get("file_name", "")
            suspicious_extensions = [".exe", ".bat", ".cmd", ".scr", ".pif"]
            if any(file_name.lower().endswith(ext)
                   for ext in suspicious_extensions):
                is_malicious = True
                threat_level = ThreatLevel.HIGH
                confidence = 0.8
                detected_patterns.append("suspicious_extension")
                risk_factors.append("executable_file")

            return {
                "threat_level": threat_level,
                "is_malicious": is_malicious,
                "confidence": confidence,
                "detected_patterns": detected_patterns,
                "risk_factors": risk_factors
            }

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤: {e}")
            return {
                "threat_level": ThreatLevel.SAFE,
                "is_malicious": False,
                "confidence": 0.0,
                "detected_patterns": [],
                "risk_factors": []
            }

    async def _analyze_links(self, content: str) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ —Å—Å—ã–ª–æ–∫ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏"""
        try:
            import re

            # –ü–æ–∏—Å–∫ —Å—Å—ã–ª–æ–∫
            url_pattern = r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+'
            urls = re.findall(url_pattern, content)

            is_malicious = False
            detected_patterns = []
            risk_factors = []

            for url in urls:
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–º–µ–Ω—ã
                suspicious_domains = [
                    "bit.ly", "tinyurl.com", "goo.gl", "t.co",
                    "short.link", "is.gd", "v.gd"
                ]

                if any(domain in url.lower() for domain in suspicious_domains):
                    detected_patterns.append("shortened_url")
                    risk_factors.append("suspicious_domain")

                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ URL
                suspicious_keywords = [
                    "bank", "paypal", "amazon", "apple", "microsoft",
                    "google", "facebook", "instagram", "twitter"
                ]

                if any(keyword in url.lower()
                       for keyword in suspicious_keywords):
                    detected_patterns.append("brand_impersonation")
                    risk_factors.append("potential_phishing")
                    is_malicious = True

            return {
                "is_malicious": is_malicious,
                "detected_patterns": detected_patterns,
                "risk_factors": risk_factors
            }

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å—Å—ã–ª–æ–∫: {e}")
            return {
                "is_malicious": False,
                "detected_patterns": [],
                "risk_factors": []
            }

    def _get_recommended_action(self, threat_level: ThreatLevel, is_spam: bool,
                                is_phishing: bool, is_malicious: bool) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è"""
        try:
            if threat_level == ThreatLevel.CRITICAL or is_malicious:
                return "block"
            elif threat_level == ThreatLevel.HIGH or is_phishing:
                return "quarantine"
            elif threat_level == ThreatLevel.MEDIUM or is_spam:
                return "warn"
            else:
                return "allow"

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è: {e}")
            return "allow"

    async def _log_message_analysis(
            self, message_data: Dict[str, Any], result: MessageAnalysisResult) -> None:
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        try:
            if not self.db_session:
                return

            # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            message = WhatsAppMessage(
                id=self._generate_message_id(),
                message_id=result.message_id,
                chat_id=message_data.get("chat_id", ""),
                sender_id=message_data.get("sender_id", ""),
                receiver_id=message_data.get("receiver_id", ""),
                message_type=message_data.get("type", "text"),
                content=message_data.get("content", ""),
                media_url=message_data.get("media_url"),
                threat_level=result.threat_level.value,
                is_blocked=result.recommended_action in ["block", "quarantine"],
                analysis_result={
                    "is_spam": result.is_spam,
                    "is_phishing": result.is_phishing,
                    "is_malicious": result.is_malicious,
                    "confidence": result.confidence,
                    "detected_patterns": result.detected_patterns,
                    "risk_factors": result.risk_factors
                }
            )

            self.db_session.add(message)
            self.db_session.commit()

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

    def _generate_message_id(self) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID —Å–æ–æ–±—â–µ–Ω–∏—è"""
        timestamp = str(int(time.time() * 1000))
        random_part = hashlib.md5(
            f"{timestamp}{time.time()}".encode()).hexdigest()[:8]
        return f"WA_{timestamp}_{random_part}"

    async def block_contact(
            self,
            phone_number: str,
            reason: str = "Suspicious activity") -> bool:
        """–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞"""
        try:
            with self.lock:
                # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
                contact = WhatsAppContact(
                    id=self._generate_contact_id(),
                    phone_number=phone_number,
                    is_blocked=True,
                    threat_score=1.0
                )

                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                if self.db_session:
                    self.db_session.add(contact)
                    self.db_session.commit()

                # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
                self.blocked_contacts[phone_number] = contact

                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                self.stats["blocked_contacts"] += 1

                self.logger.info(
                    f"–ö–æ–Ω—Ç–∞–∫—Ç {phone_number} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {reason}")
                return True

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞: {e}")
            return False

    def _generate_contact_id(self) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∫–æ–Ω—Ç–∞–∫—Ç–∞"""
        timestamp = str(int(time.time() * 1000))
        random_part = hashlib.md5(
            f"{timestamp}{time.time()}".encode()).hexdigest()[:8]
        return f"CONTACT_{timestamp}_{random_part}"

    async def get_security_report(
            self, chat_id: Optional[str] = None) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        try:
            report = {
                "total_messages": self.stats["total_messages"],
                "analyzed_messages": self.stats["analyzed_messages"],
                "blocked_messages": self.stats["blocked_messages"],
                "threats_detected": self.stats["threats_detected"],
                "spam_detected": self.stats["spam_detected"],
                "phishing_detected": self.stats["phishing_detected"],
                "malware_detected": self.stats["malware_detected"],
                "blocked_contacts": self.stats["blocked_contacts"],
                "false_positives": self.stats["false_positives"],
                "active_chats": self.stats["active_chats"],
                "timestamp": datetime.utcnow().isoformat()
            }

            if chat_id:
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —á–∞—Ç—É
                if self.db_session:
                    chat_messages = self.db_session.query(WhatsAppMessage).filter(
                        WhatsAppMessage.chat_id == chat_id).count()

                    blocked_chat_messages = self.db_session.query(WhatsAppMessage).filter(
                        WhatsAppMessage.chat_id == chat_id,
                        WhatsAppMessage.is_blocked
                    ).count()

                    report["chat_messages"] = chat_messages
                    report["blocked_chat_messages"] = blocked_chat_messages

            return report

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}")
            return {"error": str(e)}

    async def get_status(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞"""
        try:
            return {
                "name": self.name,
                "status": "running" if self.running else "stopped",
                "config": self.config,
                "stats": self.stats,
                "security_rules": len(self.security_rules),
                "blocked_contacts": len(self.blocked_contacts),
                "ml_enabled": self.config.get("ml_enabled", False),
                "last_update": datetime.utcnow().isoformat()
            }

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {e}")
            return {"error": str(e)}


# –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async def test_whatsapp_security_bot():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WhatsAppSecurityBot"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WhatsAppSecurityBot...")

    # –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞
    bot = WhatsAppSecurityBot("TestWhatsAppBot")

    try:
        # –ó–∞–ø—É—Å–∫
        await bot.start()
        print("‚úÖ WhatsAppSecurityBot –∑–∞–ø—É—â–µ–Ω")

        # –ê–Ω–∞–ª–∏–∑ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        message_data = {
            "id": "test_msg_123",
            "content": "–°—Ä–æ—á–Ω–æ! –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Å—ã–ª–∫–µ: http://fake-bank.com",
            "type": "text",
            "sender_id": "test_sender",
            "receiver_id": "test_receiver",
            "chat_id": "test_chat"}

        result = await bot.analyze_message(message_data)
        print(
            f"‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è: {result.threat_level.value} - {result.recommended_action}")

        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
        blocked = await bot.block_contact("+1234567890", "Suspicious activity")
        print(f"‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {blocked}")

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        report = await bot.get_security_report()
        print(
            f"‚úÖ –û—Ç—á–µ—Ç –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {report['threats_detected']} —É–≥—Ä–æ–∑ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
        bot_status = await bot.get_status()
        print(f"‚úÖ –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: {bot_status['status']}")

    finally:
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
        await bot.stop()
        print("‚úÖ WhatsAppSecurityBot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –ø—Ä—è–º–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
if __name__ == "__main__":
    asyncio.run(test_whatsapp_security_bot())
