#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
InstagramSecurityBot - –ë–æ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Instagram
function_93: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –±–æ—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Instagram

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Instagram,
–≤–∫–ª—é—á–∞—é—â–µ–≥–æ:
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å—Ç–æ–≤ –∏ –∏—Å—Ç–æ—Ä–∏–π –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
- –î–µ—Ç–µ–∫—Ü–∏—è —Ñ–µ–π–∫–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏ –±–æ—Ç–æ–≤
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∏–±–µ—Ä–±—É–ª–ª–∏–Ω–≥–∞ –∏ —Ö–∞—Ä–∞—Å—Å–º–µ–Ω—Ç–∞
- –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
- –ê–Ω–∞–ª–∏–∑ —Ö–µ—à—Ç–µ–≥–æ–≤ –∏ —Ç—Ä–µ–Ω–¥–æ–≤
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –î–µ—Ç–µ–∫—Ü–∏—è deepfake –∏ –ø–æ–¥–¥–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ—Ç—Å–∫–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –∏ —ç–º–æ—Ü–∏–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∫—Ä–∞–∂–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
1. –£–º–Ω–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
2. –î–µ—Ç–µ–∫—Ü–∏—è —Ñ–µ–π–∫–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
3. –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∏–±–µ—Ä–±—É–ª–ª–∏–Ω–≥–∞
4. –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
5. –ê–Ω–∞–ª–∏–∑ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
6. –î–µ—Ç–µ–∫—Ü–∏—è deepfake
7. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ—Ç—Å–∫–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
8. –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
9. –ó–∞—â–∏—Ç–∞ –æ—Ç –∫—Ä–∞–∂–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
10. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ML –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç NLP –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç —Å Instagram Basic Display API
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –∑—Ä–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—ã–µ –¥–≤–∏–∂–∫–∏
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö —É–≥—Ä–æ–∑
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏

–ê–≤—Ç–æ—Ä: ALADDIN Security System
–í–µ—Ä—Å–∏—è: 2.0
–î–∞—Ç–∞: 2025-01-27
–õ–∏—Ü–µ–Ω–∑–∏—è: MIT
"""

import asyncio
import hashlib
import json
import logging
import os

# –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–º–ø–æ—Ä—Ç—ã
import sys
import threading
import time
from collections import defaultdict
from dataclasses import dataclass, field
from datetime import datetime, timedelta
from enum import Enum
from typing import Any, Dict, List, Optional, Tuple

import numpy as np

# –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
import redis
import sqlalchemy
from prometheus_client import Counter, Gauge, Histogram
from pydantic import BaseModel, Field, validator
from sklearn.ensemble import IsolationForest
from sklearn.preprocessing import StandardScaler
from sqlalchemy import (
    JSON,
    Boolean,
    Column,
    DateTime,
    Float,
    Integer,
    String,
    Text,
    create_engine,
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

from core.base import ComponentStatus, SecurityBase, SecurityLevel

sys.path.append(
    os.path.dirname(
        os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    )
)


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
Base = declarative_base()


class InstagramContentType(Enum):
    """–¢–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ Instagram"""

    POST = "post"
    STORY = "story"
    REEL = "reel"
    IGTV = "igtv"
    COMMENT = "comment"
    MESSAGE = "message"
    LIVE = "live"


class AccountType(Enum):
    """–¢–∏–ø—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Instagram"""

    PERSONAL = "personal"
    BUSINESS = "business"
    CREATOR = "creator"
    BOT = "bot"
    FAKE = "fake"
    SPAM = "spam"


class ThreatLevel(Enum):
    """–£—Ä–æ–≤–Ω–∏ —É–≥—Ä–æ–∑"""

    SAFE = "safe"
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"


class ModerationAction(Enum):
    """–î–µ–π—Å—Ç–≤–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏"""

    ALLOW = "allow"
    WARN = "warn"
    HIDE = "hide"
    DELETE = "delete"
    BLOCK = "block"
    REPORT = "report"


class InstagramPost(Base):
    """–ü–æ—Å—Ç Instagram"""

    __tablename__ = "instagram_posts"

    id = Column(String, primary_key=True)
    post_id = Column(String, nullable=False)
    user_id = Column(String, nullable=False)
    username = Column(String)
    content_type = Column(String, nullable=False)
    caption = Column(Text)
    media_url = Column(String)
    media_type = Column(String)
    likes_count = Column(Integer, default=0)
    comments_count = Column(Integer, default=0)
    shares_count = Column(Integer, default=0)
    timestamp = Column(DateTime, default=datetime.utcnow)
    threat_level = Column(String, default=ThreatLevel.SAFE.value)
    is_deleted = Column(Boolean, default=False)
    is_hidden = Column(Boolean, default=False)
    moderation_action = Column(String)
    analysis_result = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)


class InstagramUser(Base):
    """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Instagram"""

    __tablename__ = "instagram_users"

    id = Column(String, primary_key=True)
    user_id = Column(String, nullable=False)
    username = Column(String)
    full_name = Column(String)
    account_type = Column(String, default=AccountType.PERSONAL.value)
    is_verified = Column(Boolean, default=False)
    is_private = Column(Boolean, default=False)
    is_blocked = Column(Boolean, default=False)
    is_restricted = Column(Boolean, default=False)
    followers_count = Column(Integer, default=0)
    following_count = Column(Integer, default=0)
    posts_count = Column(Integer, default=0)
    threat_score = Column(Float, default=0.0)
    violation_count = Column(Integer, default=0)
    last_activity = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow)


class InstagramComment(Base):
    """–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π Instagram"""

    __tablename__ = "instagram_comments"

    id = Column(String, primary_key=True)
    comment_id = Column(String, nullable=False)
    post_id = Column(String, nullable=False)
    user_id = Column(String, nullable=False)
    username = Column(String)
    text = Column(Text)
    timestamp = Column(DateTime, default=datetime.utcnow)
    threat_level = Column(String, default=ThreatLevel.SAFE.value)
    is_deleted = Column(Boolean, default=False)
    is_hidden = Column(Boolean, default=False)
    moderation_action = Column(String)
    analysis_result = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)


class ContentAnalysisResult(BaseModel):
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""

    content_id: str
    content_type: InstagramContentType
    threat_level: ThreatLevel
    is_inappropriate: bool = False
    is_bullying: bool = False
    is_fake: bool = False
    is_spam: bool = False
    is_deepfake: bool = False
    is_copyright_violation: bool = False
    confidence: float = 0.0
    detected_patterns: List[str] = Field(default_factory=list)
    recommended_action: ModerationAction = ModerationAction.ALLOW
    risk_factors: List[str] = Field(default_factory=list)
    sentiment_score: float = 0.0
    emotion_tags: List[str] = Field(default_factory=list)
    analysis_timestamp: datetime = Field(default_factory=datetime.utcnow)


class InstagramSecurityConfig(BaseModel):
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Instagram"""

    content_moderation: bool = True
    fake_account_detection: bool = True
    bullying_protection: bool = True
    privacy_protection: bool = True
    deepfake_detection: bool = True
    copyright_protection: bool = True
    child_safety: bool = True
    sentiment_analysis: bool = True
    auto_moderation: bool = False
    notification_alerts: bool = True


# Prometheus –º–µ—Ç—Ä–∏–∫–∏
instagram_content_analyzed_total = Counter(
    "instagram_content_analyzed_total",
    "Total number of Instagram content analyzed",
    ["content_type", "threat_level", "account_type"],
)

instagram_threats_detected_total = Counter(
    "instagram_threats_detected_total",
    "Total number of threats detected in Instagram",
    ["threat_type", "severity"],
)

instagram_content_moderated_total = Counter(
    "instagram_content_moderated_total",
    "Total number of Instagram content moderated",
    ["action", "reason"],
)

active_instagram_accounts = Gauge(
    "active_instagram_accounts", "Number of active Instagram accounts"
)


class InstagramSecurityBot(SecurityBase):
    """
    –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –±–æ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Instagram

    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Instagram —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
    - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—Å—Ç–æ–≤ –∏ –∏—Å—Ç–æ—Ä–∏–π –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    - –î–µ—Ç–µ–∫—Ü–∏–∏ —Ñ–µ–π–∫–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏ –±–æ—Ç–æ–≤
    - –ó–∞—â–∏—Ç—ã –æ—Ç –∫–∏–±–µ—Ä–±—É–ª–ª–∏–Ω–≥–∞ –∏ —Ö–∞—Ä–∞—Å—Å–º–µ–Ω—Ç–∞
    - –ö–æ–Ω—Ç—Ä–æ–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    """

    def __init__(
        self,
        name: str = "InstagramSecurityBot",
        config: Optional[Dict[str, Any]] = None,
    ):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è InstagramSecurityBot

        Args:
            name: –ò–º—è –±–æ—Ç–∞
            config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        """
        super().__init__(name, config)

        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.default_config = {
            "redis_url": "redis://localhost:6379/0",
            "database_url": "sqlite:///instagram_security_bot.db",
            "content_moderation": True,
            "fake_account_detection": True,
            "bullying_protection": True,
            "privacy_protection": True,
            "deepfake_detection": True,
            "copyright_protection": True,
            "child_safety": True,
            "sentiment_analysis": True,
            "auto_moderation": False,
            "notification_alerts": True,
            "ml_enabled": True,
            "adaptive_learning": True,
            "real_time_monitoring": True,
            "cleanup_interval": 300,
            "metrics_enabled": True,
            "logging_enabled": True,
        }

        # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
        self.config = {**self.default_config, **(config or {})}

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.redis_client: Optional[redis.Redis] = None
        self.db_engine: Optional[sqlalchemy.Engine] = None
        self.db_session: Optional[sqlalchemy.orm.Session] = None
        self.monitored_accounts: Dict[str, InstagramUser] = {}
        self.blocked_accounts: Dict[str, InstagramUser] = {}
        self.ml_model: Optional[IsolationForest] = None
        self.scaler: Optional[StandardScaler] = None

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats = {
            "total_posts": 0,
            "analyzed_posts": 0,
            "moderated_posts": 0,
            "threats_detected": 0,
            "inappropriate_content": 0,
            "bullying_detected": 0,
            "fake_accounts_detected": 0,
            "deepfake_detected": 0,
            "copyright_violations": 0,
            "child_safety_violations": 0,
            "active_accounts": 0,
            "blocked_accounts": 0,
            "false_positives": 0,
        }

        # –ü–æ—Ç–æ–∫–∏
        self.monitoring_thread: Optional[threading.Thread] = None
        self.running = False

        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        self.lock = threading.RLock()

        self.logger.info(f"InstagramSecurityBot {name} –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

    async def start(self) -> bool:
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Instagram"""
        try:
            with self.lock:
                if self.running:
                    self.logger.warning("InstagramSecurityBot —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
                    return True

                # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                await self._setup_database()

                # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis
                await self._setup_redis()

                # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ML –º–æ–¥–µ–ª–∏
                if self.config.get("ml_enabled", True):
                    await self._setup_ml_model()

                # –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ä—É–µ–º—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
                await self._load_monitored_accounts()

                # –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                self.running = True
                self.monitoring_thread = threading.Thread(
                    target=self._monitoring_worker
                )
                self.monitoring_thread.daemon = True
                self.monitoring_thread.start()

                self.logger.info("InstagramSecurityBot –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ")
                return True

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ InstagramSecurityBot: {e}")
            return False

    async def stop(self) -> bool:
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Instagram"""
        try:
            with self.lock:
                if not self.running:
                    self.logger.warning("InstagramSecurityBot —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                    return True

                self.running = False

                # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤
                if (
                    self.monitoring_thread
                    and self.monitoring_thread.is_alive()
                ):
                    self.monitoring_thread.join(timeout=5)

                # –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                if self.db_session:
                    self.db_session.close()

                if self.redis_client:
                    self.redis_client.close()

                self.logger.info("InstagramSecurityBot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                return True

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ InstagramSecurityBot: {e}")
            return False

    async def _setup_database(self) -> None:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            database_url = self.config.get(
                "database_url", "sqlite:///instagram_security_bot.db"
            )
            self.db_engine = create_engine(database_url)
            Base.metadata.create_all(self.db_engine)

            Session = sessionmaker(bind=self.db_engine)
            self.db_session = Session()

            self.logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö InstagramSecurityBot –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
            raise

    async def _setup_redis(self) -> None:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis"""
        try:
            redis_url = self.config.get(
                "redis_url", "redis://localhost:6379/0"
            )
            self.redis_client = redis.from_url(
                redis_url, decode_responses=True
            )

            # –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            self.redis_client.ping()

            self.logger.info("Redis –¥–ª—è InstagramSecurityBot –Ω–∞—Å—Ç—Ä–æ–µ–Ω")

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Redis: {e}")
            raise

    async def _setup_ml_model(self) -> None:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ML –º–æ–¥–µ–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        try:
            self.ml_model = IsolationForest(
                contamination=0.1, random_state=42, n_estimators=100
            )
            self.scaler = StandardScaler()

            self.logger.info("ML –º–æ–¥–µ–ª—å InstagramSecurityBot –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ML –º–æ–¥–µ–ª–∏: {e}")

    async def _load_monitored_accounts(self) -> None:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ä—É–µ–º—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤"""
        try:
            if self.db_session:
                accounts = (
                    self.db_session.query(InstagramUser)
                    .filter(InstagramUser.is_blocked.is_(False))
                    .all()
                )

                for account in accounts:
                    self.monitored_accounts[account.user_id] = account

                self.stats["active_accounts"] = len(self.monitored_accounts)

                self.logger.info(
                    f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.monitored_accounts)} –º–æ–Ω–∏—Ç–æ—Ä–∏—Ä—É–µ–º—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤"
                )

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ä—É–µ–º—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤: {e}")

    def _monitoring_worker(self) -> None:
        """–§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""
        while self.running:
            try:
                time.sleep(1)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                self._update_stats()

                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                self._process_content_queue()

            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {e}")

    def _update_stats(self) -> None:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        try:
            with self.lock:
                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ Prometheus
                active_instagram_accounts.set(self.stats["active_accounts"])

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

    def _process_content_queue(self) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        try:
            # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            # –ü–æ–∫–∞ —á—Ç–æ –∑–∞–≥–ª—É—à–∫–∞
            pass

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {e}")

    async def analyze_content(
        self, content_data: Dict[str, Any]
    ) -> ContentAnalysisResult:
        """–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ Instagram –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —É–≥—Ä–æ–∑"""
        try:
            content_id = content_data.get("id", "")
            content_type = InstagramContentType(
                content_data.get("type", "post")
            )
            caption = content_data.get("caption", "")
            # media_url = content_data.get("media_url", "")
            media_type = content_data.get("media_type", "")
            # user_id = content_data.get("user", {}).get("id", "")
            # username = content_data.get("user", {}).get("username", "")
            account_type = AccountType(
                content_data.get("user", {}).get("account_type", "personal")
            )

            # –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
            threat_level = ThreatLevel.SAFE
            is_inappropriate = False
            is_bullying = False
            is_fake = False
            is_spam = False
            is_deepfake = False
            is_copyright_violation = False
            confidence = 0.0
            detected_patterns = []
            risk_factors = []
            sentiment_score = 0.0
            emotion_tags = []

            # –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            if caption:
                text_analysis = await self._analyze_text_content(caption)
                threat_level = max(
                    threat_level,
                    text_analysis["threat_level"],
                    key=lambda x: x.value,
                )
                is_inappropriate = text_analysis["is_inappropriate"]
                is_bullying = text_analysis["is_bullying"]
                is_spam = text_analysis["is_spam"]
                confidence = max(confidence, text_analysis["confidence"])
                detected_patterns.extend(text_analysis["detected_patterns"])
                risk_factors.extend(text_analysis["risk_factors"])
                sentiment_score = text_analysis["sentiment_score"]
                emotion_tags.extend(text_analysis["emotion_tags"])

            # –ê–Ω–∞–ª–∏–∑ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
            if media_type:
                media_analysis = await self._analyze_media_content(
                    content_data
                )
                threat_level = max(
                    threat_level,
                    media_analysis["threat_level"],
                    key=lambda x: x.value,
                )
                is_inappropriate = (
                    is_inappropriate or media_analysis["is_inappropriate"]
                )
                is_deepfake = media_analysis["is_deepfake"]
                is_copyright_violation = media_analysis[
                    "is_copyright_violation"
                ]
                confidence = max(confidence, media_analysis["confidence"])
                detected_patterns.extend(media_analysis["detected_patterns"])
                risk_factors.extend(media_analysis["risk_factors"])

            # –ê–Ω–∞–ª–∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            account_analysis = await self._analyze_account(
                content_data.get("user", {})
            )
            if account_analysis["is_fake"]:
                is_fake = True
                threat_level = max(
                    threat_level, ThreatLevel.MEDIUM, key=lambda x: x.value
                )
                detected_patterns.extend(account_analysis["detected_patterns"])
                risk_factors.extend(account_analysis["risk_factors"])

            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
            recommended_action = self._get_recommended_action(
                threat_level,
                is_inappropriate,
                is_bullying,
                is_fake,
                is_spam,
                is_deepfake,
                is_copyright_violation,
            )

            # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
            result = ContentAnalysisResult(
                content_id=content_id,
                content_type=content_type,
                threat_level=threat_level,
                is_inappropriate=is_inappropriate,
                is_bullying=is_bullying,
                is_fake=is_fake,
                is_spam=is_spam,
                is_deepfake=is_deepfake,
                is_copyright_violation=is_copyright_violation,
                confidence=confidence,
                detected_patterns=detected_patterns,
                recommended_action=recommended_action,
                risk_factors=risk_factors,
                sentiment_score=sentiment_score,
                emotion_tags=emotion_tags,
            )

            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            self.stats["total_posts"] += 1
            self.stats["analyzed_posts"] += 1

            if threat_level != ThreatLevel.SAFE:
                self.stats["threats_detected"] += 1

            if is_inappropriate:
                self.stats["inappropriate_content"] += 1

            if is_bullying:
                self.stats["bullying_detected"] += 1

            if is_fake:
                self.stats["fake_accounts_detected"] += 1

            if is_deepfake:
                self.stats["deepfake_detected"] += 1

            if is_copyright_violation:
                self.stats["copyright_violations"] += 1

            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
            instagram_content_analyzed_total.labels(
                content_type=content_type.value,
                threat_level=threat_level.value,
                account_type=account_type.value,
            ).inc()

            if threat_level != ThreatLevel.SAFE:
                instagram_threats_detected_total.labels(
                    threat_type="general", severity=threat_level.value
                ).inc()

            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            await self._log_content_analysis(content_data, result)

            return result

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {e}")
            return ContentAnalysisResult(
                content_id=content_data.get("id", ""),
                content_type=InstagramContentType.POST,
                threat_level=ThreatLevel.SAFE,
                recommended_action=ModerationAction.ALLOW,
            )

    async def _analyze_text_content(self, text: str) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        try:
            threat_level = ThreatLevel.SAFE
            is_inappropriate = False
            is_bullying = False
            is_spam = False
            confidence = 0.0
            detected_patterns = []
            risk_factors = []
            sentiment_score = 0.0
            emotion_tags = []

            text_lower = text.lower()

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
            inappropriate_keywords = [
                "–ø–æ—Ä–Ω–æ",
                "xxx",
                "—Å–µ–∫—Å",
                "–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏",
                "–Ω–∞—Ä–∫–æ—Ç–∏–∫",
                "–æ—Ä—É–∂–∏–µ",
                "–≤–∑—Ä—ã–≤—á–∞—Ç–∫–∞",
                "—Ç–µ—Ä—Ä–æ—Ä",
                "—ç–∫—Å—Ç—Ä–µ–º–∏–∑–º",
                "–Ω–∞—Å–∏–ª–∏–µ",
                "–∂–µ—Å—Ç–æ–∫–æ—Å—Ç—å",
                "—Å–∞–º–æ—É–±–∏–π—Å—Ç–≤–æ",
            ]

            inappropriate_count = sum(
                1
                for keyword in inappropriate_keywords
                if keyword in text_lower
            )
            if inappropriate_count >= 1:
                is_inappropriate = True
                threat_level = ThreatLevel.HIGH
                confidence = 0.9
                detected_patterns.append("inappropriate_content")
                risk_factors.append("inappropriate_keywords")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∏–±–µ—Ä–±—É–ª–ª–∏–Ω–≥
            bullying_keywords = [
                "—Ç—É–ø–æ–π",
                "–∏–¥–∏–æ—Ç",
                "–¥–µ–±–∏–ª",
                "—É—Ä–æ–¥",
                "–∂–∏—Ä–Ω—ã–π",
                "—É—Ä–æ–¥–ª–∏–≤—ã–π",
                "–Ω–µ–Ω–∞–≤–∏–∂—É",
                "—É–±–∏–π",
                "—É–º—Ä–∏",
            ]

            bullying_count = sum(
                1 for keyword in bullying_keywords if keyword in text_lower
            )
            if bullying_count >= 2:
                is_bullying = True
                threat_level = max(
                    threat_level, ThreatLevel.MEDIUM, key=lambda x: x.value
                )
                confidence = max(confidence, 0.7)
                detected_patterns.append("bullying")
                risk_factors.append("bullying_keywords")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º
            spam_indicators = [
                "—Ä–µ–∫–ª–∞–º–∞",
                "–∑–∞—Ä–∞–±–æ—Ç–æ–∫",
                "–±—ã—Å—Ç—Ä–æ",
                "–ª–µ–≥–∫–æ",
                "–±–µ—Å–ø–ª–∞—Ç–Ω–æ",
                "—Å—Ä–æ—á–Ω–æ",
                "—Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è",
                "–Ω–µ —É–ø—É—Å—Ç–∏—Ç–µ",
                "–≥–∞—Ä–∞–Ω—Ç–∏—è",
                "–ø–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å",
                "–ª–∞–π–∫–∞–π—Ç–µ",
                "—Ä–µ–ø–æ—Å—Ç–∏—Ç–µ",
            ]

            spam_count = sum(
                1 for indicator in spam_indicators if indicator in text_lower
            )
            if spam_count >= 3:
                is_spam = True
                threat_level = max(
                    threat_level, ThreatLevel.MEDIUM, key=lambda x: x.value
                )
                confidence = max(confidence, 0.6)
                detected_patterns.append("spam_indicators")
                risk_factors.append("spam_keywords")

            # –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
            positive_words = [
                "—Ö–æ—Ä–æ—à–æ",
                "–æ—Ç–ª–∏—á–Ω–æ",
                "–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ",
                "–ª—é–±–ª—é",
                "–Ω—Ä–∞–≤–∏—Ç—Å—è",
                "–∫–ª–∞—Å—Å–Ω–æ",
            ]
            negative_words = [
                "–ø–ª–æ—Ö–æ",
                "—É–∂–∞—Å–Ω–æ",
                "–Ω–µ–Ω–∞–≤–∏–∂—É",
                "–æ—Ç–≤—Ä–∞—Ç–∏—Ç–µ–ª—å–Ω–æ",
                "—É–∂–∞—Å",
                "–∫–æ—à–º–∞—Ä",
            ]

            positive_count = sum(
                1 for word in positive_words if word in text_lower
            )
            negative_count = sum(
                1 for word in negative_words if word in text_lower
            )

            if positive_count > negative_count:
                sentiment_score = 0.5 + (positive_count - negative_count) * 0.1
                emotion_tags.append("positive")
            elif negative_count > positive_count:
                sentiment_score = (
                    -0.5 - (negative_count - positive_count) * 0.1
                )
                emotion_tags.append("negative")
            else:
                sentiment_score = 0.0
                emotion_tags.append("neutral")

            return {
                "threat_level": threat_level,
                "is_inappropriate": is_inappropriate,
                "is_bullying": is_bullying,
                "is_spam": is_spam,
                "confidence": confidence,
                "detected_patterns": detected_patterns,
                "risk_factors": risk_factors,
                "sentiment_score": sentiment_score,
                "emotion_tags": emotion_tags,
            }

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {e}")
            return {
                "threat_level": ThreatLevel.SAFE,
                "is_inappropriate": False,
                "is_bullying": False,
                "is_spam": False,
                "confidence": 0.0,
                "detected_patterns": [],
                "risk_factors": [],
                "sentiment_score": 0.0,
                "emotion_tags": [],
            }

    async def _analyze_media_content(
        self, content_data: Dict[str, Any]
    ) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤"""
        try:
            # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–º –∑—Ä–µ–Ω–∏–µ–º
            # –ü–æ–∫–∞ —á—Ç–æ –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

            threat_level = ThreatLevel.SAFE
            is_inappropriate = False
            is_deepfake = False
            is_copyright_violation = False
            confidence = 0.0
            detected_patterns = []
            risk_factors = []

            media_type = content_data.get("media_type", "")
            # media_url = content_data.get("media_url", "")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
            file_size = content_data.get("file_size", 0)
            if file_size > 100 * 1024 * 1024:  # 100MB
                detected_patterns.append("large_file")
                risk_factors.append("suspicious_file_size")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            if media_type in ["video", "image"]:
                # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ deepfake
                # –ü–æ–∫–∞ —á—Ç–æ –∑–∞–≥–ª—É—à–∫–∞
                pass

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤
            # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤
            # –ü–æ–∫–∞ —á—Ç–æ –∑–∞–≥–ª—É—à–∫–∞

            return {
                "threat_level": threat_level,
                "is_inappropriate": is_inappropriate,
                "is_deepfake": is_deepfake,
                "is_copyright_violation": is_copyright_violation,
                "confidence": confidence,
                "detected_patterns": detected_patterns,
                "risk_factors": risk_factors,
            }

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤: {e}")
            return {
                "threat_level": ThreatLevel.SAFE,
                "is_inappropriate": False,
                "is_deepfake": False,
                "is_copyright_violation": False,
                "confidence": 0.0,
                "detected_patterns": [],
                "risk_factors": [],
            }

    async def _analyze_account(
        self, user_data: Dict[str, Any]
    ) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            is_fake = False
            detected_patterns = []
            risk_factors = []

            # user_id = user_data.get("id", "")
            # username = user_data.get("username", "")
            followers_count = user_data.get("followers_count", 0)
            following_count = user_data.get("following_count", 0)
            posts_count = user_data.get("posts_count", 0)
            is_verified = user_data.get("is_verified", False)
            is_private = user_data.get("is_private", False)

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–µ–π–∫–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
            # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–æ–∫
            if following_count > 0 and followers_count / following_count < 0.1:
                is_fake = True
                detected_patterns.append("suspicious_follow_ratio")
                risk_factors.append("fake_account_indicators")

            # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –º–∞–ª–æ –ø–æ—Å—Ç–æ–≤ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
            if followers_count > 1000 and posts_count < 10:
                is_fake = True
                detected_patterns.append("low_posts_high_followers")
                risk_factors.append("fake_account_indicators")

            # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            # if username and len(username) < 3:
            #     detected_patterns.append("suspicious_username")
            #     risk_factors.append("fake_account_indicators")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–æ—Ç–∞
            if not is_verified and not is_private and followers_count > 10000:
                detected_patterns.append("potential_bot")
                risk_factors.append("automated_activity")

            return {
                "is_fake": is_fake,
                "detected_patterns": detected_patterns,
                "risk_factors": risk_factors,
            }

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∞–∫–∫–∞—É–Ω—Ç–∞: {e}")
            return {
                "is_fake": False,
                "detected_patterns": [],
                "risk_factors": [],
            }

    def _get_recommended_action(
        self,
        threat_level: ThreatLevel,
        is_inappropriate: bool,
        is_bullying: bool,
        is_fake: bool,
        is_spam: bool,
        is_deepfake: bool,
        is_copyright_violation: bool,
    ) -> ModerationAction:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏"""
        try:
            if (
                threat_level == ThreatLevel.CRITICAL
                or is_inappropriate
                or is_bullying
            ):
                return ModerationAction.BLOCK
            elif (
                threat_level == ThreatLevel.HIGH
                or is_deepfake
                or is_copyright_violation
            ):
                return ModerationAction.DELETE
            elif threat_level == ThreatLevel.MEDIUM or is_spam or is_fake:
                return ModerationAction.HIDE
            else:
                return ModerationAction.ALLOW

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è: {e}")
            return ModerationAction.ALLOW

    async def _log_content_analysis(
        self, content_data: Dict[str, Any], result: ContentAnalysisResult
    ) -> None:
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        try:
            if self.db_session is None:
                return

            # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ—Å—Ç–∞
            post = InstagramPost(
                id=self._generate_content_id(),
                post_id=result.content_id,
                user_id=content_data.get("user", {}).get("id", ""),
                username=content_data.get("user", {}).get("username"),
                content_type=result.content_type.value,
                caption=content_data.get("caption", ""),
                media_url=content_data.get("media_url", ""),
                media_type=content_data.get("media_type", ""),
                threat_level=result.threat_level.value,
                is_deleted=result.recommended_action
                in [ModerationAction.DELETE, ModerationAction.BLOCK],
                is_hidden=result.recommended_action == ModerationAction.HIDE,
                moderation_action=result.recommended_action.value,
                analysis_result={
                    "is_inappropriate": result.is_inappropriate,
                    "is_bullying": result.is_bullying,
                    "is_fake": result.is_fake,
                    "is_spam": result.is_spam,
                    "is_deepfake": result.is_deepfake,
                    "is_copyright_violation": result.is_copyright_violation,
                    "confidence": result.confidence,
                    "detected_patterns": result.detected_patterns,
                    "risk_factors": result.risk_factors,
                    "sentiment_score": result.sentiment_score,
                    "emotion_tags": result.emotion_tags,
                },
            )

            self.db_session.add(post)
            self.db_session.commit()

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {e}")

    def _generate_content_id(self) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        timestamp = str(int(time.time() * 1000))
        random_part = hashlib.md5(
            f"{timestamp}{time.time()}".encode()
        ).hexdigest()[:8]
        return f"IG_{timestamp}_{random_part}"

    async def block_account(
        self, user_id: str, reason: str = "Suspicious activity"
    ) -> bool:
        """–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞"""
        try:
            with self.lock:
                # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
                account = InstagramUser(
                    id=self._generate_account_id(),
                    user_id=user_id,
                    is_blocked=True,
                    threat_score=1.0,
                )

                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                if self.db_session:
                    self.db_session.add(account)
                    self.db_session.commit()

                # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
                self.blocked_accounts[user_id] = account

                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                self.stats["blocked_accounts"] += 1

                self.logger.info(f"–ê–∫–∫–∞—É–Ω—Ç {user_id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {reason}")
                return True

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞: {e}")
            return False

    def _generate_account_id(self) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∞–∫–∫–∞—É–Ω—Ç–∞"""
        timestamp = str(int(time.time() * 1000))
        random_part = hashlib.md5(
            f"{timestamp}{time.time()}".encode()
        ).hexdigest()[:8]
        return f"ACCOUNT_{timestamp}_{random_part}"

    async def add_account_to_monitoring(
        self, user_data: Dict[str, Any]
    ) -> bool:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"""
        try:
            with self.lock:
                user_id = user_data.get("id", "")

                # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
                account = InstagramUser(
                    id=self._generate_account_id(),
                    user_id=user_id,
                    username=user_data.get("username"),
                    full_name=user_data.get("full_name"),
                    account_type=user_data.get(
                        "account_type", AccountType.PERSONAL.value
                    ),
                    is_verified=user_data.get("is_verified", False),
                    is_private=user_data.get("is_private", False),
                    followers_count=user_data.get("followers_count", 0),
                    following_count=user_data.get("following_count", 0),
                    posts_count=user_data.get("posts_count", 0),
                )

                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                if self.db_session:
                    self.db_session.add(account)
                    self.db_session.commit()

                # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ä—É–µ–º—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
                self.monitored_accounts[user_id] = account

                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                self.stats["active_accounts"] += 1

                self.logger.info(f"–ê–∫–∫–∞—É–Ω—Ç {user_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥")
                return True

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: {e}")
            return False

    async def get_security_report(
        self, user_id: Optional[str] = None
    ) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        try:
            report = {
                "total_posts": self.stats["total_posts"],
                "analyzed_posts": self.stats["analyzed_posts"],
                "moderated_posts": self.stats["moderated_posts"],
                "threats_detected": self.stats["threats_detected"],
                "inappropriate_content": self.stats["inappropriate_content"],
                "bullying_detected": self.stats["bullying_detected"],
                "fake_accounts_detected": self.stats["fake_accounts_detected"],
                "deepfake_detected": self.stats["deepfake_detected"],
                "copyright_violations": self.stats["copyright_violations"],
                "child_safety_violations": self.stats[
                    "child_safety_violations"
                ],
                "active_accounts": self.stats["active_accounts"],
                "blocked_accounts": self.stats["blocked_accounts"],
                "false_positives": self.stats["false_positives"],
                "timestamp": datetime.utcnow().isoformat(),
            }

            if user_id:
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                if self.db_session:
                    user_posts = (
                        self.db_session.query(InstagramPost)
                        .filter(InstagramPost.user_id == user_id)
                        .count()
                    )

                    deleted_user_posts = (
                        self.db_session.query(InstagramPost)
                        .filter(
                            InstagramPost.user_id == user_id,
                            InstagramPost.is_deleted,
                        )
                        .count()
                    )

                    report["user_posts"] = user_posts
                    report["deleted_user_posts"] = deleted_user_posts

            return report

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}")
            return {"error": str(e)}

    async def get_status(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞"""
        try:
            return {
                "name": self.name,
                "status": "running" if self.running else "stopped",
                "config": self.config,
                "stats": self.stats,
                "monitored_accounts": len(self.monitored_accounts),
                "blocked_accounts": len(self.blocked_accounts),
                "ml_enabled": self.config.get("ml_enabled", False),
                "last_update": datetime.utcnow().isoformat(),
            }

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {e}")
            return {"error": str(e)}


# –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async def test_instagram_security_bot():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ InstagramSecurityBot"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ InstagramSecurityBot...")

    # –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞
    bot = InstagramSecurityBot("TestInstagramBot")

    try:
        # –ó–∞–ø—É—Å–∫
        await bot.start()
        print("‚úÖ InstagramSecurityBot –∑–∞–ø—É—â–µ–Ω")

        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        user_data = {
            "id": "123456789",
            "username": "test_user",
            "full_name": "Test User",
            "account_type": "personal",
            "is_verified": False,
            "is_private": False,
            "followers_count": 1000,
            "following_count": 500,
            "posts_count": 50,
        }

        account_added = await bot.add_account_to_monitoring(user_data)
        print(f"‚úÖ –ê–∫–∫–∞—É–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: {account_added}")

        # –ê–Ω–∞–ª–∏–∑ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
        content_data = {
            "id": "post_12345",
            "type": "post",
            "caption": "–û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å! –õ—é–±–ª—é —Å–≤–æ—é –∂–∏–∑–Ω—å! ‚ù§Ô∏è #happy #life",
            "media_url": "https://example.com/image.jpg",
            "media_type": "image",
            "user": user_data,
        }

        result = await bot.analyze_content(content_data)
        print(
            f"‚úÖ –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {result.threat_level.value} - {result.recommended_action.value}"
        )

        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
        blocked = await bot.block_account("987654321", "Spam activity")
        print(f"‚úÖ –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {blocked}")

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        report = await bot.get_security_report()
        print(
            f"‚úÖ –û—Ç—á–µ—Ç –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {report['threats_detected']} —É–≥—Ä–æ–∑ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
        )

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
        bot_status = await bot.get_status()
        print(f"‚úÖ –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: {bot_status['status']}")

    finally:
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
        await bot.stop()
        print("‚úÖ InstagramSecurityBot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –ø—Ä—è–º–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
if __name__ == "__main__":
    asyncio.run(test_instagram_security_bot())
