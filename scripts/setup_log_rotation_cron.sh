#!/bin/bash
# -*- coding: utf-8 -*-
"""
Setup Log Rotation Cron - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
–°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ cron
"""

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ ALADDIN"
echo "=================================================="

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
CURRENT_DIR=$(pwd)
SCRIPT_PATH="$CURRENT_DIR/scripts/log_rotation_manager.py"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "‚ùå –°–∫—Ä–∏–ø—Ç —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω: $SCRIPT_PATH"
    exit 1
fi

echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: $CURRENT_DIR"
echo "üìÑ –°–∫—Ä–∏–ø—Ç —Ä–æ—Ç–∞—Ü–∏–∏: $SCRIPT_PATH"

# –°–æ–∑–¥–∞–µ–º cron –∑–∞–¥–∞—á—É
CRON_JOB="0 2 * * 0 cd $CURRENT_DIR && python3 $SCRIPT_PATH >> logs/rotation.log 2>&1"

echo "‚è∞ Cron –∑–∞–¥–∞—á–∞: $CRON_JOB"

# –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ crontab
(crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -

if [ $? -eq 0 ]; then
    echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo "üìÖ –†–æ—Ç–∞—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 02:00"
    echo "üìÑ –õ–æ–≥–∏ —Ä–æ—Ç–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤: logs/rotation.log"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ cron –∑–∞–¥–∞—á–∏
    echo ""
    echo "üìã –¢–µ–∫—É—â–∏–µ cron –∑–∞–¥–∞—á–∏:"
    crontab -l | grep -E "(log_rotation|ALADDIN)" || echo "   (–∑–∞–¥–∞—á–∏ ALADDIN –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)"
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cron –∑–∞–¥–∞—á–∏"
    exit 1
fi

echo ""
echo "üîß –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ—Ç–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "   python3 $SCRIPT_PATH"
echo ""
echo "üìä –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ª–æ–≥–æ–≤ —Ä–æ—Ç–∞—Ü–∏–∏:"
echo "   tail -f logs/rotation.log"