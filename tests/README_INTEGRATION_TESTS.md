# Интеграционные тесты Service Mesh Manager

## Обзор

Этот набор интеграционных тестов предназначен для тестирования Service Mesh Manager в реальных сценариях использования. Тесты проверяют взаимодействие между различными компонентами системы, производительность, отказоустойчивость и масштабируемость.

## Структура тестов

### 1. Основные интеграционные тесты (`test_integration.py`)

- **TestServiceMeshIntegration** - основные интеграционные тесты
- **TestServiceMeshEndToEnd** - end-to-end тесты

#### Покрываемые сценарии:
- Полный жизненный цикл сервисов
- Зависимости между сервисами
- Балансировка нагрузки
- Circuit Breaker
- Проверка здоровья
- Сбор метрик
- Система событий
- Кэширование
- Асинхронные операции
- Prometheus метрики
- Структурированное логирование
- Обработка ошибок
- Конкурентные операции
- Восстановление системы
- Управление конфигурацией
- Мониторинг

### 2. Тесты архитектурных сценариев (`test_integration_scenarios.py`)

- **TestMicroservicesArchitecture** - тесты различных архитектур
- **TestServiceMeshResilience** - тесты отказоустойчивости

#### Покрываемые архитектуры:
- **E-commerce приложение** - полная архитектура интернет-магазина
- **IoT система** - архитектура для Интернета вещей
- **Финансовые сервисы** - архитектура банковской системы

#### Покрываемые аспекты отказоустойчивости:
- Circuit Breaker
- Балансировка нагрузки
- Проверка здоровья
- Сбор метрик

### 3. Тесты производительности (`test_performance_integration.py`)

- **TestPerformanceIntegration** - тесты производительности

#### Покрываемые аспекты производительности:
- Пропускная способность (throughput)
- Задержка (latency)
- Конкурентные операции
- Использование памяти
- Использование CPU
- Масштабируемость
- Стресс-тестирование
- Тестирование выносливости

## Запуск тестов

### Базовый запуск

```bash
# Все интеграционные тесты
python3 run_integration_tests.py

# Только основные интеграционные тесты
python3 run_integration_tests.py --type integration

# Только тесты сценариев
python3 run_integration_tests.py --type scenarios

# Только тесты производительности
python3 run_integration_tests.py --type performance
```

### Специализированные тесты

```bash
# E-commerce архитектура
python3 run_integration_tests.py --type ecommerce

# IoT архитектура
python3 run_integration_tests.py --type iot

# Финансовые сервисы
python3 run_integration_tests.py --type financial

# Тесты отказоустойчивости
python3 run_integration_tests.py --type resilience

# Стресс-тестирование
python3 run_integration_tests.py --type stress

# Тестирование выносливости
python3 run_integration_tests.py --type endurance

# Тестирование масштабируемости
python3 run_integration_tests.py --type scalability
```

### Опции запуска

```bash
# Подробный вывод
python3 run_integration_tests.py --verbose

# Только тесты производительности
python3 run_integration_tests.py --performance

# Установка таймаута
python3 run_integration_tests.py --timeout 600
```

### Прямой запуск pytest

```bash
# Все интеграционные тесты
python3 -m pytest test_integration*.py -v

# Тесты производительности
python3 -m pytest test_performance_integration.py -v -m performance

# Конкретный тест
python3 -m pytest test_integration.py::TestServiceMeshIntegration::test_full_service_lifecycle -v
```

## Маркеры тестов

- `integration` - Интеграционные тесты
- `performance` - Тесты производительности
- `slow` - Медленные тесты
- `ecommerce` - E-commerce архитектура
- `iot` - IoT архитектура
- `financial` - Финансовые сервисы
- `resilience` - Отказоустойчивость
- `stress` - Стресс-тестирование
- `endurance` - Тестирование выносливости
- `scalability` - Масштабируемость
- `memory` - Тесты памяти
- `cpu` - Тесты CPU
- `latency` - Тесты задержки
- `throughput` - Тесты пропускной способности
- `concurrent` - Конкурентные операции

## Требования к производительности

### Пропускная способность
- Минимум 10 запросов в секунду (базовый тест)
- Минимум 5 запросов в секунду (конкурентные тесты)
- Минимум 2 запроса в секунду (масштабируемость)
- Минимум 1 запрос в секунду (стресс-тест)

### Задержка
- Средняя задержка менее 1 секунды
- 95% запросов менее 2 секунд
- 99% запросов менее 5 секунд

### Успешность
- Минимум 90% успешных запросов (базовый тест)
- Минимум 80% успешных запросов (конкурентные тесты)
- Минимум 70% успешных запросов (стресс-тест)

### Ресурсы
- Максимум 50MB увеличения памяти
- Максимум 80% использования CPU
- Максимум 100 секунд для базовых тестов
- Максимум 600 секунд для стресс-тестов

## Архитектурные сценарии

### E-commerce приложение
- API Gateway
- User Service (управление пользователями)
- Product Service (каталог товаров)
- Order Service (обработка заказов)
- Payment Service (обработка платежей)
- Notification Service (уведомления)
- Database Service (база данных)
- Cache Service (кэширование)

### IoT система
- Device Gateway (шлюз устройств)
- Sensor Service (обработка данных датчиков)
- Analytics Service (аналитика)
- Alert Service (система алертов)
- Message Queue Service (очереди сообщений)
- Time Series Database (база временных рядов)
- Database Service (основная база данных)
- Cache Service (кэширование)
- Notification Service (уведомления)

### Финансовые сервисы
- API Gateway (шлюз API)
- Account Service (управление счетами)
- Transaction Service (обработка транзакций)
- Payment Service (обработка платежей)
- Security Service (безопасность)
- Audit Service (аудит)
- Reporting Service (отчетность)
- Analytics Service (аналитика)
- Database Service (база данных)
- Cache Service (кэширование)
- Message Queue Service (очереди сообщений)

## Мониторинг и метрики

Тесты проверяют:
- Сбор метрик производительности
- Системные метрики
- Prometheus метрики
- Структурированное логирование
- Статистику кэширования
- Статистику асинхронных операций

## Отказоустойчивость

Тесты проверяют:
- Работу Circuit Breaker
- Балансировку нагрузки при отказе узлов
- Проверку здоровья сервисов
- Восстановление после ошибок
- Обработку исключений
- Конкурентные операции

## Зависимости

- pytest
- pytest-timeout
- psutil (для тестов производительности)
- threading
- asyncio
- concurrent.futures

## Конфигурация

- `pytest-integration.ini` - конфигурация pytest для интеграционных тестов
- `run_integration_tests.py` - скрипт для запуска тестов
- Таймаут по умолчанию: 300 секунд
- Максимальное количество потоков: 10

## Примеры использования

### Тестирование e-commerce архитектуры
```bash
python3 run_integration_tests.py --type ecommerce --verbose
```

### Стресс-тестирование
```bash
python3 run_integration_tests.py --type stress --timeout 600
```

### Тестирование производительности
```bash
python3 run_integration_tests.py --type performance --verbose
```

### Полный набор тестов
```bash
python3 run_integration_tests.py --verbose --timeout 600
```

## Результаты тестирования

Тесты выводят:
- Пропускную способность (запросов в секунду)
- Процент успешных запросов
- Время выполнения
- Использование памяти
- Использование CPU
- Задержки (средняя, P95, P99, максимальная)
- Количество потоков и запросов

## Устранение неполадок

### Таймауты
- Увеличьте таймаут с помощью `--timeout`
- Проверьте производительность системы

### Ошибки памяти
- Уменьшите количество запросов в тестах
- Проверьте настройки системы

### Ошибки CPU
- Уменьшите количество потоков
- Проверьте нагрузку на систему

### Ошибки сети
- Проверьте доступность localhost
- Проверьте настройки портов

## Расширение тестов

Для добавления новых тестов:
1. Создайте новый класс тестов
2. Добавьте соответствующие маркеры
3. Обновите документацию
4. Добавьте новые опции в скрипт запуска

## Поддержка

При возникновении проблем:
1. Проверьте логи тестов
2. Убедитесь, что все зависимости установлены
3. Проверьте конфигурацию системы
4. Обратитесь к команде разработки
